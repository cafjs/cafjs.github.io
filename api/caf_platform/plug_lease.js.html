<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: plug_lease.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: plug_lease.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*!
Copyright 2013 Hewlett-Packard Development Company, L.P.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
'use strict';
/**
 * A plug to an external service that maintains leases on CAs.
 *
 * A lease protects a binding between a CA identifier and a location. This
 * binding ensures that CAs are unique across the data center, and therefore,
 * they will properly serialize state changes, and provide a consistent view to
 * the external world.
 *
 * If the node owning the lease crashes, the lease eventually expires.
 * At that point a different, randomly picked, node can create a new lease
 * and restart the CA safely.
 *
 *
 * @module caf_platform/plug_lease
 * @augments external:caf_components/gen_plug
 */
var assert = require('assert');
var caf_comp = require('caf_components');
var genPlug = caf_comp.gen_plug;

exports.newInstance = function($, spec, cb) {
    try {
        var that = genPlug.constructor($, spec);
        /* Time in seconds before a new lease expires.*/
        var leaseTimeout = spec.env.leaseTimeout;
        assert.equal(typeof leaseTimeout, 'number',
                     "'spec.env.leaseTimeout' is not a number");
        $._.$.log &amp;&amp; $._.$.log.debug('New lease plug');

        /**
         * Gets the duration of a lease in seconds.
         *
         * @return {number} The lease timeout in seconds.
         *
         * @memberof! module:caf_platform/plug_lease#
         * @alias getLeaseTimeout
         */
        that.getLeaseTimeout = function() {
            return leaseTimeout;
        };

        /**
         * Grabs a lease that guarantees exclusive ownership of a CA by this
         *  node.
         *
         * The type of `caf.remoteNode` is `{remoteNode:string}|null`.
         *
         * @param {string} id  An identifier for the CA.
         * @param {function(caf.remoteNode)} cb0 A callback of type
         * `function(caf.remoteNode)`. If we failed to acquire the lease, the
         * argument contains the current owner. Otherwise, the argument is
         * `null`, and we got the lease.
         *
         * @memberof! module:caf_platform/plug_lease#
         * @alias grabLease
         */
        that.grabLease = function(id, cb0) {
            try {
                $._.$.cp.grabLease(id, leaseTimeout, cb0);
            } catch (err) {
                cb0(err);
            }
        };


        /**
         * Renews a list of leases currently owned by this node.
         *
         * @param {Array.&lt;string>} ids A list of identifiers for local CAs.
         * @param {function(Object, Array.&lt;string>)} cb0 A callback of type
         * `function(Object, Array.&lt;string>)` with either
         * an error (first) argument, or a (second) argument with a list of CA
         * identifiers that we failed to renew.
         *
         * @memberof! module:caf_platform/plug_lease#
         * @alias renewLeases
         */
        that.renewLeases = function(ids, cb0) {
            try {
                if (ids.length === 0) {
                    cb0(null, []);
                } else {
                    $._.$.cp.renewLeases(ids, leaseTimeout, cb0);
                }
            } catch (err) {
                cb0(err);
            }
        };

        cb(null, that);
    } catch (err) {
        cb(err);
    }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-caf_platform_cron_lease.html">caf_platform/cron_lease</a></li><li><a href="module-caf_platform_cron_nodes.html">caf_platform/cron_nodes</a></li><li><a href="module-caf_platform_cron_pulser.html">caf_platform/cron_pulser</a></li><li><a href="module-caf_platform_cron_ripper.html">caf_platform/cron_ripper</a></li><li><a href="module-caf_platform_cron_security.html">caf_platform/cron_security</a></li><li><a href="module-caf_platform_gen_pipe.html">caf_platform/gen_pipe</a></li><li><a href="module-caf_platform_main.html">caf_platform/main</a></li><li><a href="module-caf_platform_pipe_bodyParser.html">caf_platform/pipe_bodyParser</a></li><li><a href="module-caf_platform_pipe_cache.html">caf_platform/pipe_cache</a></li><li><a href="module-caf_platform_pipe_compress.html">caf_platform/pipe_compress</a></li><li><a href="module-caf_platform_pipe_dispatcher.html">caf_platform/pipe_dispatcher</a></li><li><a href="module-caf_platform_pipe_ping.html">caf_platform/pipe_ping</a></li><li><a href="module-caf_platform_pipe_redirect.html">caf_platform/pipe_redirect</a></li><li><a href="module-caf_platform_pipe_security.html">caf_platform/pipe_security</a></li><li><a href="module-caf_platform_pipe_static.html">caf_platform/pipe_static</a></li><li><a href="module-caf_platform_pipe_stats.html">caf_platform/pipe_stats</a></li><li><a href="module-caf_platform_pipeline_main.html">caf_platform/pipeline_main</a></li><li><a href="module-caf_platform_platform_main.html">caf_platform/platform_main</a></li><li><a href="module-caf_platform_plug_lease.html">caf_platform/plug_lease</a></li><li><a href="module-caf_platform_plug_nodes.html">caf_platform/plug_nodes</a></li><li><a href="module-caf_platform_plug_paas.html">caf_platform/plug_paas</a></li><li><a href="module-caf_platform_plug_registry.html">caf_platform/plug_registry</a></li></ul><h3>Externals</h3><ul><li><a href="external-caf_ca.html">caf_ca</a></li><li><a href="external-caf_cli.html">caf_cli</a></li><li><a href="external-caf_components_gen_container.html">caf_components/gen_container</a></li><li><a href="external-caf_components_gen_cron.html">caf_components/gen_cron</a></li><li><a href="external-caf_components_gen_dynamic_container.html">caf_components/gen_dynamic_container</a></li><li><a href="external-caf_components_gen_plug.html">caf_components/gen_plug</a></li><li><a href="external-caf_components_gen_supervisor.html">caf_components/gen_supervisor</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon Dec 19 2016 01:50:07 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
