<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>gen_dynamic_container.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-caf_components_containerUtils.html">caf_components/containerUtils</a><ul class='methods'><li data-type='method'><a href="module-caf_components_containerUtils.html#.utils">utils</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#checkAndRestartChild">checkAndRestartChild</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#checkChild">checkChild</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#createChild">createChild</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#ensureShutdown">ensureShutdown</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#many">many</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#shutdownChild">shutdownChild</a></li></ul></li><li><a href="module-caf_components_gen_component.html">caf_components/gen_component</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_component.html">__ca_checkup__</a></li><li data-type='method'><a href="module-caf_components_gen_component.html">__ca_getSpec__</a></li><li data-type='method'><a href="module-caf_components_gen_component.html">__ca_shutdown__</a></li><li data-type='method'><a href="module-caf_components_gen_component.html#.create">create</a></li></ul></li><li><a href="module-caf_components_gen_container.html">caf_components/gen_container</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_container.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_container.html#__ca_getChildrenSpec__">__ca_getChildrenSpec__</a></li></ul></li><li><a href="module-caf_components_gen_cron.html">caf_components/gen_cron</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_cron.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_cron.html#__ca_getInterval__">__ca_getInterval__</a></li><li data-type='method'><a href="module-caf_components_gen_cron.html#__ca_start__">__ca_start__</a></li><li data-type='method'><a href="module-caf_components_gen_cron.html#__ca_stop__">__ca_stop__</a></li></ul></li><li><a href="module-caf_components_gen_dynamic_container.html">caf_components/gen_dynamic_container</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#__ca_allChildren__">__ca_allChildren__</a></li><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#__ca_deleteChild__">__ca_deleteChild__</a></li><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#__ca_getChildSpec__">__ca_getChildSpec__</a></li><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#__ca_instanceChild__">__ca_instanceChild__</a></li></ul></li><li><a href="module-caf_components_gen_loader.html">caf_components/gen_loader</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_loader.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_firstModulePath__">__ca_firstModulePath__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_getModuleIndex__">__ca_getModuleIndex__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_loadComponent__">__ca_loadComponent__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_loadDescription__">__ca_loadDescription__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_loadResource__">__ca_loadResource__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_registerLogger__">__ca_registerLogger__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_setModules__">__ca_setModules__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_setStaticArtifacts__">__ca_setStaticArtifacts__</a></li></ul></li><li><a href="module-caf_components_gen_plug.html">caf_components/gen_plug</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_plug.html#.create">create</a></li></ul></li><li><a href="module-caf_components_gen_plug_ca.html">caf_components/gen_plug_ca</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_plug_ca.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_plug_ca.html#__ca_getCAName__">__ca_getCAName__</a></li></ul></li><li><a href="module-caf_components_gen_proxy.html">caf_components/gen_proxy</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_proxy.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_proxy.html#__ca_getCAName__">__ca_getCAName__</a></li></ul></li><li><a href="module-caf_components_gen_supervisor.html">caf_components/gen_supervisor</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_supervisor.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_supervisor.html#__ca_start__">__ca_start__</a></li><li data-type='method'><a href="module-caf_components_gen_supervisor.html#__ca_stop__">__ca_stop__</a></li></ul></li><li><a href="module-caf_components_gen_transactional.html">caf_components/gen_transactional</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_transactional.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_abort__">__ca_abort__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_begin__">__ca_begin__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_commit__">__ca_commit__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_init__">__ca_init__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_lazyApply__">__ca_lazyApply__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_prepare__">__ca_prepare__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_resume__">__ca_resume__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_setLogActionsTarget__">__ca_setLogActionsTarget__</a></li></ul></li><li><a href="module-caf_components_main.html">caf_components/main</a><ul class='methods'><li data-type='method'><a href="module-caf_components_main.html">load</a></li></ul></li><li><a href="module-caf_components_myUtils.html">caf_components/myUtils</a><ul class='methods'><li data-type='method'><a href="module-caf_components_myUtils.html">callJustOnce</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">cloneAndMixin</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">condPromisify</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">deepClone</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">deepEqual</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">deleteProps</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">errToPrettyStr</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">errToStr</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">extractData</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">hashCode</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">mixin</a></li><li data-type='method'><a href="module-caf_components_myUtils.html#.clone">clone</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">onlyFun</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">promiseToCallback</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">randomString</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">retryWithDelay</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">superior</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">superiorPromisify</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">uniqueId</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">wrapAsyncFunction</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">wrapWithTimeout</a></li></ul></li><li><a href="module-caf_components_naming.html">caf_components/naming</a></li><li><a href="module-caf_components_plug_ca_log.html">caf_components/plug_ca_log</a><ul class='methods'><li data-type='method'><a href="module-caf_components_plug_ca_log.html#.newInstance">newInstance</a></li></ul></li><li><a href="module-caf_components_plug_log.html">caf_components/plug_log</a><ul class='methods'><li data-type='method'><a href="module-caf_components_plug_log.html#.newInstance">newInstance</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#currentLevel">currentLevel</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#debug">debug</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#error">error</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#fatal">fatal</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#info">info</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#isActive">isActive</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#setLevel">setLevel</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#trace">trace</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#warn">warn</a></li></ul></li><li><a href="module-caf_components_proxy_log.html">caf_components/proxy_log</a><ul class='methods'><li data-type='method'><a href="module-caf_components_proxy_log.html#.newInstance">newInstance</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#debug">debug</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#error">error</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#fatal">fatal</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#info">info</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#isActive">isActive</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#trace">trace</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#warn">warn</a></li></ul></li><li><a href="module-caf_components_supervisor.html">caf_components/supervisor</a><ul class='methods'><li data-type='method'><a href="module-caf_components_supervisor.html#.newInstance">newInstance</a></li></ul></li><li><a href="module-caf_components_templateUtils.html">caf_components/templateUtils</a><ul class='methods'><li data-type='method'><a href="module-caf_components_templateUtils.html">merge</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~mergeComponents">mergeComponents</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~mergeEnv">mergeEnv</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~mergeObj">mergeObj</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~parseString">parseString</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~patchEnv">patchEnv</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~patchOneEnv">patchOneEnv</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html">resolveEnv</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html">resolveLinks</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">gen_dynamic_container.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Modifications copyright 2020 Caf.js Labs and contributors
/*!
 Copyright 2014 Hewlett-Packard Development Company, L.P.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 */
'use strict';

/**
 *  Generic dynamic container component that encapsulates the life-cycle of
 * other components.
 *
 * Container membership changes at run-time.
 *
 * We use a supervisor strategy similar to Erlang/OTP `one-for-one`:
 *  components are assumed to be independent, and if one of them dies we just
 *  restart that component. Order of component shutdown or start is arbitrary.
 *
 * The child's `spec.env` can contain a boolean attribute
 * `__ca_temporary__` that disables component restart. This is useful when we
 * rely on external  mechanisms to restart components, as is the case with CAs.
 *
 *  The following required properties specify recovery behavior for
*  non-temporary components:
 *
 *         { maxRetries: number, retryDelay: number}
 *
 *  where `maxRetries` is the number of attempts before giving up, and
 * `retryDelay` is the delay in msec between attempts.
 *
 *
 * @module caf_components/gen_dynamic_container
 * @augments module:caf_components/gen_component
 *
 */
// @ts-ignore: augments not attached to a class

const assert = require('assert');
const genComponent = require('./gen_component');
const async = require('async');
const myUtils = require('./myUtils');
const containerUtils = require('./containerUtils');
const naming = require('./naming');

/**
 * Helper constructor method for a dynamic container component.
 *
 * Description of types in file `types.js`.
 *
 * @param {ctxType} $ A context containing references to other components.
 * @param {specType} spec Configuration data for this component.
 * @return {Object} A new generic component.
 *
 * @throws {Error} If inputs are invalid.
 */
exports.create = function($, spec) {

    const that = genComponent.create($, spec);

    assert.equal(typeof(spec.env.maxRetries), 'number',
                 "'spec.env.maxRetries' is not a number");
    assert.equal(typeof(spec.env.retryDelay), 'number',
                 "'spec.env.retryDelay' is not a number");

    const cntUtils = containerUtils.utils(that, spec.env.maxRetries,
                                          spec.env.retryDelay);

    /**
     * Run-time type information.
     *
     * @type {boolean}
     * @memberof! module:caf_components/gen_dynamic_container#
     * @alias __ca_isDynamicContainer__
     */
    that.__ca_isDynamicContainer__ = true;

    $._ = $._ || that; // It is a top level component if missing $._


    /**
     * A context to register children. We can pass an existing children context
     * in $.$
     *
     * @type {Object.&lt;string, Object>}
     * @memberof! module:caf_components/gen_dynamic_container#
     * @alias $
     */
    that.$ = $.$ || {};

    that.$._ = $._;

    assert.equal(typeof($._), 'object',
                 "'$' context has no global context '$._'");
    assert.equal(typeof($._.$), 'object',
                 "'$._' object has no context '$._.$'");

    /*
     * Map with expected child components.
     *
     * @type {Object.&lt;string, specType>}
     */
    const childrenSpecObj = {};

    /**
     *  Returns the spec for a created child.
     *
     * @param {string} name The name of the child component.
     *
     * @return {specType} The spec of a running child.
     *
     * @memberof! module:caf_components/gen_dynamic_container#
     * @alias __ca_getChildSpec__
     */
    that.__ca_getChildSpec__ = function(name) {
        return childrenSpecObj[name];
    };

    /*
     *  Adds a new child component.
     *
     * @param {Object=} data An optional hint on how to add the child.
     * @param {Object} childSpec A child description.
     * @param {cbType} cb A callback to return an error if I cannot create the
     *  child.
     *
     */
    const createChild = function(data, childSpec, cb) {
        childrenSpecObj[childSpec.name] = childSpec;
        const cb0 = function(err, resp) {
            if (err &amp;&amp; childSpec.env.__ca_temporary__) {
                delete childrenSpecObj[childSpec.name];
            }
            cb(err, resp);
        };
        cntUtils.createChild(data, true)(childSpec, cb0);
    };

    /*
     * We avoid name conflicts during child creation by using queues. We hash
     * the child name, and pick one of the queues to allow for some concurrency.
     *
     */
    const NUMBER_OF_QUEUES = 47;

    const queues = [];
    for (let i =0; i &lt; NUMBER_OF_QUEUES; i++) {
        queues[i] = async
            .queue(function(req, cb) {
                const data = req.data;
                const childSpec = req.childSpec;
                if (that.$[childSpec.name]) {
                    // @ts-ignore: return data in 'async' callback
                    cb(null, that.$[childSpec.name]);
                } else {
                    createChild(data, childSpec, cb);
                }
            }, 1); //sequential
    }

    /**
     * Adds a new child component if it was not already created.
     *
     * We avoid race conditions by using a queue to serialize child creation.
     *
     * There is no guarantee that the returned child used the provided
     * description, it could have already been created with a different
     * one. Use `__ca_deleteChild__` first to force a description.
     *
     * @param {Object=} data An optional hint on how to add the child.
     * @param {Object} childSpec A child description.
     * @param {cbType} cb A callback to return an error or the new (or existing)
     * child.
     *
     * @memberof! module:caf_components/gen_dynamic_container#
     * @alias __ca_instanceChild__
     */
    that.__ca_instanceChild__ = function(data, childSpec, cb) {
        const index = myUtils.hashCode(childSpec.name)%NUMBER_OF_QUEUES;
        queues[index].push({data: data, childSpec: childSpec}, cb);
    };

    /**
     * Deletes and shutdowns a child component.
     *
     * This is an idempotent operation.
     *
     * @param {Object=} data An optional hint on how to delete the child.
     * @param {string} childName A name for the child.
     * @param {cbType} cb A callback to return an error if a child still exists
     * and `delete` failed.
     *
     * @memberof! module:caf_components/gen_dynamic_container#
     * @alias __ca_deleteChild__
     */
    that.__ca_deleteChild__ = function(data, childName, cb) {
        if (childrenSpecObj[childName]) {
            delete childrenSpecObj[childName];
            cntUtils.shutdownChild(data, true)(childName, cb);
        } else {
            cb(null);
        }
    };


    const known = function() {
        return Object.keys(that.$)
            .filter(function(x) {
                return (childrenSpecObj[x] !== undefined);
            });
    };

    /**
     * Returns an array with the names of all the children that are currently
     * active.
     *
     * @return {Array.&lt;string>} The names of all active children.
     *
     * @memberof! module:caf_components/gen_dynamic_container#
     * @alias __ca_allChildren__
     */
    that.__ca_allChildren__ = function() {
        return known();
    };

    const unknown = function() {
        return Object.keys(that.$)
            .filter(function(x) {
                return ((x !== naming.TOP) &amp;&amp; (x !== naming.CA) &amp;&amp;
                        (x !== naming.LOADER) &amp;&amp;
                        (!that.$[x].__ca_isNotUnknown__) &amp;&amp;
                        (childrenSpecObj[x] === undefined));
            });
    };

    /*
     * Reconciliates the current children state with the expected one.
     *
     *
     * @param {Object} data A hint on how to perform the checkup.
     * @param {cbType} cb A callback to propagate a checkup error/success.
     */
    const checkupChildren = function(data, cb) {
        async.series([
            cntUtils.many('shutdownChild', unknown(), data),
            // childrenSpecObj type cannot be {}??
            // @ts-ignore
            cntUtils.many('checkAndRestartChild', childrenSpecObj, data, true)
        ], cb);
    };

    const super__ca_checkup__ = myUtils.superior(that, '__ca_checkup__');
    that.__ca_checkup__ = myUtils.condPromisify(function(data, cb) {
        super__ca_checkup__(data, function(err) {
            if (err) {
                cb(err);
            } else {
                cntUtils.ensureShutdown(checkupChildren, data, function(err) {
                    if (err) {
                        // Cannot recover children, shutdown and propagate error
                        that.__ca_shutdown__(data, function(err1) {
                            if (err1) {
                                cb(err1);
                            } else {
                                cb(err);
                            }
                        });
                    } else {
                        cb(null);
                    }
                });
            }
        });
    });

    const super__ca_shutdown__ = myUtils.superior(that, '__ca_shutdown__');
    that.__ca_shutdown__ = myUtils.condPromisify(function(data, cb) {
        super__ca_shutdown__(data, function(err) {
            if (err) {
                cb(err);
            } else {
                cntUtils.many('shutdownChild', unknown().concat(known()), data)(
                    function(err) {
                        if (err) {
                            const msgLog = 'Error in child shutdown: ' +
                                      spec.name + ' due to ' +
                                      myUtils.errToPrettyStr(err);
                            $._.$.log &amp;&amp; $._.$.log.debug(msgLog);
                        }
                        cb(err);
                    }
                );
            }
        });
    });

    return that;
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Nov 19 2021 19:03:24 GMT-0800 (Pacific Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
