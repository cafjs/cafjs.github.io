<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>gen_container.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-caf_components_containerUtils.html">caf_components/containerUtils</a><ul class='methods'><li data-type='method'><a href="module-caf_components_containerUtils.html#.utils">utils</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#checkAndRestartChild">checkAndRestartChild</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#checkChild">checkChild</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#createChild">createChild</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#ensureShutdown">ensureShutdown</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#many">many</a></li><li data-type='method'><a href="module-caf_components_containerUtils.html#shutdownChild">shutdownChild</a></li></ul></li><li><a href="module-caf_components_gen_component.html">caf_components/gen_component</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_component.html">__ca_checkup__</a></li><li data-type='method'><a href="module-caf_components_gen_component.html">__ca_getSpec__</a></li><li data-type='method'><a href="module-caf_components_gen_component.html">__ca_shutdown__</a></li><li data-type='method'><a href="module-caf_components_gen_component.html#.create">create</a></li></ul></li><li><a href="module-caf_components_gen_container.html">caf_components/gen_container</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_container.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_container.html#__ca_getChildrenSpec__">__ca_getChildrenSpec__</a></li></ul></li><li><a href="module-caf_components_gen_cron.html">caf_components/gen_cron</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_cron.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_cron.html#__ca_getInterval__">__ca_getInterval__</a></li><li data-type='method'><a href="module-caf_components_gen_cron.html#__ca_start__">__ca_start__</a></li><li data-type='method'><a href="module-caf_components_gen_cron.html#__ca_stop__">__ca_stop__</a></li></ul></li><li><a href="module-caf_components_gen_dynamic_container.html">caf_components/gen_dynamic_container</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#__ca_allChildren__">__ca_allChildren__</a></li><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#__ca_deleteChild__">__ca_deleteChild__</a></li><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#__ca_getChildSpec__">__ca_getChildSpec__</a></li><li data-type='method'><a href="module-caf_components_gen_dynamic_container.html#__ca_instanceChild__">__ca_instanceChild__</a></li></ul></li><li><a href="module-caf_components_gen_loader.html">caf_components/gen_loader</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_loader.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_firstModulePath__">__ca_firstModulePath__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_getModuleIndex__">__ca_getModuleIndex__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_loadComponent__">__ca_loadComponent__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_loadDescription__">__ca_loadDescription__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_loadResource__">__ca_loadResource__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_registerLogger__">__ca_registerLogger__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_setModules__">__ca_setModules__</a></li><li data-type='method'><a href="module-caf_components_gen_loader.html#__ca_setStaticArtifacts__">__ca_setStaticArtifacts__</a></li></ul></li><li><a href="module-caf_components_gen_plug.html">caf_components/gen_plug</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_plug.html#.create">create</a></li></ul></li><li><a href="module-caf_components_gen_plug_ca.html">caf_components/gen_plug_ca</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_plug_ca.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_plug_ca.html#__ca_getCAName__">__ca_getCAName__</a></li></ul></li><li><a href="module-caf_components_gen_proxy.html">caf_components/gen_proxy</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_proxy.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_proxy.html#__ca_getCAName__">__ca_getCAName__</a></li></ul></li><li><a href="module-caf_components_gen_supervisor.html">caf_components/gen_supervisor</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_supervisor.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_supervisor.html#__ca_start__">__ca_start__</a></li><li data-type='method'><a href="module-caf_components_gen_supervisor.html#__ca_stop__">__ca_stop__</a></li></ul></li><li><a href="module-caf_components_gen_transactional.html">caf_components/gen_transactional</a><ul class='methods'><li data-type='method'><a href="module-caf_components_gen_transactional.html#.create">create</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_abort__">__ca_abort__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_begin__">__ca_begin__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_commit__">__ca_commit__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_init__">__ca_init__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_lazyApply__">__ca_lazyApply__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_prepare__">__ca_prepare__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_resume__">__ca_resume__</a></li><li data-type='method'><a href="module-caf_components_gen_transactional.html#__ca_setLogActionsTarget__">__ca_setLogActionsTarget__</a></li></ul></li><li><a href="module-caf_components_main.html">caf_components/main</a><ul class='methods'><li data-type='method'><a href="module-caf_components_main.html">load</a></li></ul></li><li><a href="module-caf_components_myUtils.html">caf_components/myUtils</a><ul class='methods'><li data-type='method'><a href="module-caf_components_myUtils.html">callJustOnce</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">cloneAndMixin</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">condPromisify</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">deepClone</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">deepEqual</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">deleteProps</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">errToPrettyStr</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">errToStr</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">extractData</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">hashCode</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">mixin</a></li><li data-type='method'><a href="module-caf_components_myUtils.html#.clone">clone</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">onlyFun</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">promiseToCallback</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">randomString</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">retryWithDelay</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">superior</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">superiorPromisify</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">uniqueId</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">wrapAsyncFunction</a></li><li data-type='method'><a href="module-caf_components_myUtils.html">wrapWithTimeout</a></li></ul></li><li><a href="module-caf_components_naming.html">caf_components/naming</a></li><li><a href="module-caf_components_plug_ca_log.html">caf_components/plug_ca_log</a><ul class='methods'><li data-type='method'><a href="module-caf_components_plug_ca_log.html#.newInstance">newInstance</a></li></ul></li><li><a href="module-caf_components_plug_log.html">caf_components/plug_log</a><ul class='methods'><li data-type='method'><a href="module-caf_components_plug_log.html#.newInstance">newInstance</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#currentLevel">currentLevel</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#debug">debug</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#error">error</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#fatal">fatal</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#info">info</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#isActive">isActive</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#setLevel">setLevel</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#trace">trace</a></li><li data-type='method'><a href="module-caf_components_plug_log.html#warn">warn</a></li></ul></li><li><a href="module-caf_components_proxy_log.html">caf_components/proxy_log</a><ul class='methods'><li data-type='method'><a href="module-caf_components_proxy_log.html#.newInstance">newInstance</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#debug">debug</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#error">error</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#fatal">fatal</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#info">info</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#isActive">isActive</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#trace">trace</a></li><li data-type='method'><a href="module-caf_components_proxy_log.html#warn">warn</a></li></ul></li><li><a href="module-caf_components_supervisor.html">caf_components/supervisor</a><ul class='methods'><li data-type='method'><a href="module-caf_components_supervisor.html#.newInstance">newInstance</a></li></ul></li><li><a href="module-caf_components_templateUtils.html">caf_components/templateUtils</a><ul class='methods'><li data-type='method'><a href="module-caf_components_templateUtils.html">merge</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~mergeComponents">mergeComponents</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~mergeEnv">mergeEnv</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~mergeObj">mergeObj</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~parseString">parseString</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~patchEnv">patchEnv</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html#~patchOneEnv">patchOneEnv</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html">resolveEnv</a></li><li data-type='method'><a href="module-caf_components_templateUtils.html">resolveLinks</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">gen_container.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// Modifications copyright 2020 Caf.js Labs and contributors
/*!
Copyright 2013 Hewlett-Packard Development Company, L.P.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
'use strict';
/**
 * Generic container component that encapsulates the life-cycle of
 * other components.
 *
 * A container is static, using a description list to create child components,
 *  allocating a new context to register them, and propagating
 *  actions as needed. Unknown children are shutdown without triggering
 * a recovery strategy.
 *
 * We use a supervisor strategy similar to Erlang/OTP `one-for-all`: If a
 * child is missing or shutdown,  we will shutdown all the remaining
 * children first, and then restart them all. Recovery actions order is based
 * on description order, to ensure that dependent services will also recover.
 *
 *  The following required properties specify recovery behavior:
 *
 *         { maxRetries: number, retryDelay: number}
 *
 *  where `maxRetries` is the number of attempts before giving up, and
 * `retryDelay` is the delay in msec between attempts.
 *
 * We want to avoid split brain situations: two instances of the
 * same component assuming that they are unique, and, for example,
 * interacting with the external world.
 *
 * For this reason, we cannot restart
 * a child until a previous shutdown has been successful. Shutdown is
 * always idempotent, and we retry multiple times. Eventually we give up
 * and trigger a process shutdown, relying on an external
 * recovery mechanism to restart the process.
 *
 * Static containers are not adequate for managing CAs. CAs are mostly
 * independent from each other, and created dynamically. See
 * `gen_dynamic_container` for an alternative.
 *
 *
 * @module caf_components/gen_container
 * @augments module:caf_components/gen_component
 */
// @ts-ignore: augments not attached to a class
const assert = require('assert');
const genComponent = require('./gen_component');
const async = require('async');
const myUtils = require('./myUtils');
const containerUtils = require('./containerUtils');
const naming = require('./naming');

/**
 * Helper constructor method for a container component.
 *
 * Description of types in file `types.js`.
 *
 * @param {ctxType} $ A context containing references to other components.
 * @param {specType} spec Configuration data for this component.
 * @return {Object} A new generic component.
 *
 * @throws {Error} If inputs are invalid.
 */
exports.create = function($, spec) {

    const that = genComponent.create($, spec);

    assert.equal(typeof(spec.env.maxRetries), 'number',
                 "'spec.env.maxRetries' is not a number");
    assert.equal(typeof(spec.env.retryDelay), 'number',
                 "'spec.env.retryDelay' is not a number");

    const cntUtils = containerUtils.utils(that, spec.env.maxRetries,
                                          spec.env.retryDelay);

    /**
     * Run-time type information.
     *
     * @type {boolean}
     *
     * @memberof! module:caf_components/gen_container#
     * @alias __ca_isContainer__
     */
    that.__ca_isContainer__ = true;

    $._ = $._ || that; // It is a top level component if missing $._

    /**
     * A context to register children.
     *
     * Provide an existing children context in `$.$`, otherwise a new one is
     * created.
     *
     * @type {ctxType}
     * @memberof! module:caf_components/gen_container#
     * @alias $
     */
    that.$ = $.$ || {};

    that.$._ = $._;

    assert.equal(typeof($._), 'object',
                 "'$' context has no global context '$._'");
    assert.equal(typeof($._.$), 'object',
                 "'$._' object has no context '$._.$'");

    /*
     * A description of the expected children.
     *
     * @type {Array.&lt;specType>}
     *
     */
    const childrenSpec = myUtils.clone(spec.components || []);

    const childrenNames = childrenSpec.map(function(x) { return x.name;});

    const toObject = function(spec) {
        const result = {};
        spec.forEach(function(x) {
            if (result[x.name]) {
                const msg ='Ignoring duplicate:' + x.name + ' in spec';
                const err = new Error(msg);
                err['spec'] = spec;
                $._.$.log &amp;&amp; $._.$.log.error(myUtils.errToPrettyStr(err));
                throw err;
            } else {
                result[x.name] = x;
            }
        });
        return result;
    };


    const childrenSpecObj = toObject(childrenSpec);


    /**
     * Gets a description of the expected children.
     *
     * @return {Array.&lt;specType>} A description of the expected children.
     *
     * @memberof! module:caf_components/gen_container#
     * @alias __ca_getChildrenSpec__
     *
     */
    that.__ca_getChildrenSpec__ = function() {
        return myUtils.clone(childrenSpec); //static container, no spec changes!
    };


    /*
     *  Filter current children based on whether they are expected.
     *
     * @param {boolean} known True if we want to select present and expected
     * children, false if present and unexpected.
     *
     * @return {Array.&lt;string>} Names of the selected children.
     *
     */
    const selectChildren = function(known) {
        if (known) {
            return childrenSpec
                .filter(function(x) {
                    return (that.$[x.name] !== undefined);
                })
                .map(function(x) { return x.name;});
        } else {
            return Object.keys(that.$)
                .filter(function(x) {
                    return ((x !== naming.TOP) &amp;&amp; (x !== naming.CA) &amp;&amp;
                            (x !== naming.LOADER) &amp;&amp;
                            (!that.$[x].__ca_isNotUnknown__) &amp;&amp;
                            (childrenSpecObj[x] === undefined));
                });
        }
    };

    const unknown = function() { return selectChildren(false);};

    const known = function() { return selectChildren(true);};

    const restartAll = function(data, cb) {
        async.series([
            cntUtils.many('shutdownChild', known().reverse(), data),
            cntUtils.many('createChild', childrenSpec, data, true)
        ], cb);
    };

    /*
     * Reconciliates the current children state with the expected one.
     *
     *
     * @param {Object} data A hint on how to perform the checkup. If
     * `data.doNotRestart` is true, we do not attempt recovery, propagating
     * an error in the callback instead. If an object is passed, the flag
     * `restartAll` will be set to true when the children are restarted.
     * @param {cbType} cb A callback to propagate a checkup error/success.
     */
    const checkupChildren = function(data, cb) {
        async.series([
            cntUtils.many('shutdownChild', unknown(), data),
            function (cb1) {
                const cb2 = function(err, res) {
                    if (err) {
                        if (data &amp;&amp; data.doNotRestart) {
                            const logMsg = 'Cannot restart children in ' +
                                      spec.name + ' got error ' +
                                      myUtils.errToPrettyStr(err);
                            $._.$.log &amp;&amp; $._.$.log.trace(logMsg);
                            cb1(err);
                        } else {
                            const logMsg = 'Restarting children in ' +
                                      spec.name + ' due to error ' +
                                      myUtils.errToPrettyStr(err);
                            $._.$.log &amp;&amp; $._.$.log.trace(logMsg);
                            if (data &amp;&amp; typeof data === 'object') {
                                data.restartAll = true;
                            }
                            restartAll(data, cb1);
                        }
                    } else {
                        cb1(err, res);
                    }
                };
                cntUtils.many('checkChild', childrenNames, data)(cb2);
            }
        ], cb);
    };


    const super__ca_checkup__ = myUtils.superior(that, '__ca_checkup__');
    that.__ca_checkup__ = myUtils.condPromisify(function(data, cb) {
        super__ca_checkup__(data, function(err) {
            if (err) {
                cb(err);
            } else {
                cntUtils.ensureShutdown(checkupChildren, data, function(err) {
                    if (err) {
                        // Cannot recover children, shutdown and propagate error
                        that.__ca_shutdown__(data, function(err1) {
                            if (err1) {
                                cb(err1);
                            } else {
                                cb(err);
                            }
                        });
                    } else {
                        cb(null);
                    }
                });
            }
        });
    });

    const super__ca_shutdown__ = myUtils.superior(that, '__ca_shutdown__');
    that.__ca_shutdown__ = myUtils.condPromisify(function(data, cb) {
        super__ca_shutdown__(data, function(err) {
            if (err) {
                cb(err);
            } else {
                const all = unknown().concat(known()).reverse();
                cntUtils.many('shutdownChild', all, data)(function(err) {
                    if (err) {
                        const msgLog = 'Child shutdown error in ' + spec.name +
                                  ' due to ' + myUtils.errToPrettyStr(err);
                        $._.$.log &amp;&amp; $._.$.log.debug(msgLog);
                    }
                    cb(err);
                });
            }
        });
    });

    return that;
};
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Thu Apr 29 2021 13:47:40 GMT-0700 (Pacific Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
