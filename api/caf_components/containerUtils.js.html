<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: containerUtils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: containerUtils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/*!
 Copyright 2014 Hewlett-Packard Development Company, L.P.

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
 */
'use strict';

/**
 * Common functions for static and dynamic containers.
 *
 *
 * @module caf_components/containerUtils
 *
 */
var async = require('async');
var myUtils = require('./myUtils');
var assert = require('assert');
var timers = require('timers');

/**
 * Constructor of utils object.
 *
 * @param {Object} that Target container object.
 * @param {number} maxRetries Number of retries before giving up.
 * @param {number} retryDelay Delay in msec before retrying.
 */
exports.utils = function(that, maxRetries, retryDelay) {

    var result = {};

    var METHODS_INPUT_TYPE = {
        checkChild: 'string',
        checkAndRestartChild: 'object',
        shutdownChild: 'string',
        createChild: 'object'
    };

    /**
     *  Returns a function that checks a child status.
     *
     *  @param {Object=} data Optional meta-data for checks or to return
     * info.
     *
     *  @return {function(string, cbType)} A function of type
     * `function(string, cbType)` that will check
     * a child component status. If the child is missing or shutdown it will
     * return an error using the callback.
     *
     * @memberof! module:caf_components/containerUtils#
     * @alias checkChild
     */
    result.checkChild = function(data) {
        return function(childName, cb) {
            var child = that.$[childName];
            if (child) {
                child.__ca_checkup__(data, cb);
            } else {
                var err = new Error('checkChild: missing child');
                err.name = childName;
                cb(err);
            }
        };
    };

    /**
     *  Returns a function that checks a child status, and restarts it if
     *  needed.
     *
     *
     *  @param {Object=} data Optional meta-data for checks or to return
     * info. If  'data.doNotRestart' is true, it does not attempt recovery,
     * propagating an error in the callback.
     *
     *  @param {boolean=} doRetry True if it should retry a failed restart,
     *  otherwise no retry.
     *
     *  @return {function(specType, cbType)} A function of type
     * `function(specType, cbType)` that will check and restart a child
     *  component.
     *
     * @memberof! module:caf_components/containerUtils#
     * @alias checkAndRestartChild
     */
    result.checkAndRestartChild = function(data, doRetry) {
        return function(childSpec, cb) {
            var cb0 = function(err, res) {
                if (err) {
                    if (childSpec.env.__ca_temporary__) {
                        that.$._.$.log &amp;&amp;
                            that.$._.$.log.trace('Ignoring temporary child' +
                                                 myUtils.errToPrettyStr(err));
                        cb(null, res);
                    } else {
                        if (data &amp;&amp; data.doNotRestart) {
                            var logMsg = 'doNotRestart=true propagating error' +
                                    myUtils.errToPrettyStr(err);
                            that.$_.$.log &amp;&amp; that.$._.$.log.trace(logMsg);
                            cb(err);
                        } else {
                            logMsg = 'Creating  child ' +
                                myUtils.errToPrettyStr(err);
                            that.$._.$.log &amp;&amp; that.$._.$.log.trace(logMsg);
                            result.createChild(data, doRetry)(childSpec, cb);
                        }
                    }
                } else {
                    cb(err, res);
                }
            };
            result.checkChild(data)(childSpec.name, cb0);
        };
    };

    /**
     *  Returns a function to shutdown a child.
     *
     *  @param {Object=} data Optional meta-data for shutdown or to return
     * info.
     *
     *  @param {boolean=} doRetry True if it should retry shutdown, otherwise
     *  no retry.
     *
     *  @return {function(string, cbType)} A function of type
     * `function(string, cbType)` to shutdown a child component.
     *
     * @memberof! module:caf_components/containerUtils#
     * @alias shutdownChild
     */
    result.shutdownChild = function(data, doRetry) {
        var retries = (doRetry ? maxRetries : 1);
        return function (childName, cb) {
            var f = function(cb0) {
                var child = that.$[childName];
                if (child) {
                    that.$._.$.log &amp;&amp;
                        that.$._.$.log.trace('Shuting down child ' + childName +
                                             ' in container ' +
                                             that.__ca_getSpec__().name);
                    child.__ca_shutdown__(data, cb0);
                } else {
                    // previous shutdown eventually finished
                    cb0(null);
                }
            };
            myUtils.retryWithDelay(f, retries, retryDelay, cb);
        };
    };

    /**
     *  Returns a function that creates a new child. If necessary,
     * the function shuts down first an existing one with the same name.
     *
     *  @param {Object=} data Optional meta-date for creation or to return
     * info.
     *
     *  @param {boolean=} doRetry True if it should retry creation,
     * otherwise no retry.
     *
     *  @return {function(specType, cbType)} A function of type
     * `function(specType, cbType)` that will create
     * a child component from a description, and return it in the callback.
     *
     * @memberof! module:caf_components/containerUtils#
     * @alias createChild
     */
    result.createChild = function(data, doRetry) {
        var retries = (doRetry ? maxRetries : 1);
        return function (childSpec, cb) {
            var f = function(cb0) {
                async.series({
                    one: function(cb1) {
                        result.shutdownChild(data)(childSpec.name,
                                                   cb1);
                    },
                    comp: function(cb1) {
                        that.$._.$.loader
                            .__ca_loadComponent__(that.$,
                                                  childSpec, cb1);
                    }
                }, function(err, res) {
                    if (err) {
                        that.$._.$.log &amp;&amp;
                            that.$._.$.log
                            .debug('Error creating child' +
                                   myUtils.errToPrettyStr(err));
                        cb0(err, res);
                    } else {
                        var cb1 = function(err) {
                            cb0(err, res.comp);
                        };
                        res.comp.__ca_checkup__(data, cb1);
                    }
                });
            };
            myUtils.retryWithDelay(f, retries, retryDelay, cb);
        };
    };

    /**
     * Returns a function that serially executes a `containerUtils` method on
     * a collection of children.
     *
     * @param {string} method A method name of this object (for example,
     * `createChild`).
     * @param {Array&lt;specType| string> | Object&lt; string, specType>} all
     *  An array of children or an object with a key with a child name and a
     * value describing its  spec.
     *
     * @param {Object=}  data Optional meta-data for methods, or to return
     * info.
     *
     * @param {boolean=} doRetry True if it should retry creation, otherwise
     * no retry.
     *
     * @return {function(cbType)} A function of type `function(cbType)` that
     *  will asyncronously execute the method on the collection, and finally
     * invokes the callback with the results or an error.
     *
     * @memberof! module:caf_components/containerUtils#
     * @alias many
     *
     */
    result.many = function(method, all, data, doRetry) {
        if (!METHODS_INPUT_TYPE[method]) {
            var err = new Error('many: invalid method name');
            err.name = method;
            err['all'] = all;
            throw err;
        }
        assert.equal(typeof(all), 'object', "'all' is not an object or array");
        if (!Array.isArray(all)) {
            if (METHODS_INPUT_TYPE[method] === 'string') {
                all = Object.keys(all);
            } else {
                all = Object.keys(all).map(function (x) { return all[x]; });
            }
        }

        return function(cb) {
            var f = result[method](data, doRetry);
            var fImmediate = function(x, cb0) {
                // avoid stack overflow, and give priority to I/O ops
                timers.setImmediate(function() {
                    f(x, cb0);
                });
            };
            async.eachSeries(all, fImmediate, cb);
        };
    };

    /**
     * Enforces a shutdown invariant for a function.
     *
     * In particular, if the container is shutdown, all its children should
     * also be shutdown.
     *
     * @param {function(any, cbType)} f A function of type
     * `function(any, cbType)` that should respect a shutdown invariant.
     * @param {Object=}  data Optional meta-data.
     * @param {cbType} cb A callback for `f`  or the shutdown call.
     *
     * @memberof! module:caf_components/containerUtils#
     * @alias ensureShutdown
     */
    result.ensureShutdown = function(f, data, cb) {
        if (that.__ca_isShutdown__) {
            that.__ca_shutdown__(data, cb);
        } else {
            var cb1 = function(err, res) {
                if (that.__ca_isShutdown__) {
                    that.__ca_shutdown__(data, cb);
                } else {
                    cb(err, res);
                }
            };
            f(data, cb1);
        }
    };

    return result;
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-caf_components_containerUtils.html">caf_components/containerUtils</a></li><li><a href="module-caf_components_gen_component.html">caf_components/gen_component</a></li><li><a href="module-caf_components_gen_container.html">caf_components/gen_container</a></li><li><a href="module-caf_components_gen_cron.html">caf_components/gen_cron</a></li><li><a href="module-caf_components_gen_dynamic_container.html">caf_components/gen_dynamic_container</a></li><li><a href="module-caf_components_gen_loader.html">caf_components/gen_loader</a></li><li><a href="module-caf_components_gen_plug.html">caf_components/gen_plug</a></li><li><a href="module-caf_components_gen_plug_ca.html">caf_components/gen_plug_ca</a></li><li><a href="module-caf_components_gen_proxy.html">caf_components/gen_proxy</a></li><li><a href="module-caf_components_gen_supervisor.html">caf_components/gen_supervisor</a></li><li><a href="module-caf_components_gen_transactional.html">caf_components/gen_transactional</a></li><li><a href="module-caf_components_main.html">caf_components/main</a></li><li><a href="module-caf_components_myUtils.html">caf_components/myUtils</a></li><li><a href="module-caf_components_naming.html">caf_components/naming</a></li><li><a href="module-caf_components_plug_ca_log.html">caf_components/plug_ca_log</a></li><li><a href="module-caf_components_plug_log.html">caf_components/plug_log</a></li><li><a href="module-caf_components_proxy_log.html">caf_components/proxy_log</a></li><li><a href="module-caf_components_supervisor.html">caf_components/supervisor</a></li><li><a href="module-caf_components_templateUtils.html">caf_components/templateUtils</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Feb 06 2018 00:39:47 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
