<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Module: caf_security/tokens</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Module: caf_security/tokens</h1>

    




<section>

<header>
    
        
            
        
    
</header>

<article>
    <div class="container-overview">
    
        
            <div class="description"><p>Tokens are the primary mechanism to implement single sign on for all
 the user apps.</p>
<p>A token is used by the client to create a
secure channel with its corresponding CA running in the cloud.</p>
<p>We use the JSON Web Tokens (draft-ietf-oauth-json-web-token-32) format for
 our tokens.</p>
<p>Not all apps are equally trusted, and we want to ensure that a rogue app
cannot reuse tokens in a different context.</p>
<p>We achieve that by weakening tokens with the following optional constraints:</p>
<ul>
<li><p><code>appPublisher</code>: publisher of the app hosting CAs.</p>
</li>
<li><p><code>appLocalName</code>: name of the app in the <code>appPublisher</code> context.</p>
</li>
<li><p><code>caOwner</code>: owner name of the CA.</p>
</li>
<li><p><code>caLocalName</code>: name of the CA in the owner's context.</p>
</li>
<li><p><code>expiresAfter</code>: Expire time of token in milliseconds since midnight
January 1,1970 UTC</p>
</li>
</ul>
<p>Tokens form a meet semi-lattice, where a meet (<code>^</code>) operator defines a
 partial ordering of tokens, i.e.,:</p>
<pre class="prettyprint source"><code>             A^B = A iff A &lt;= B</code></pre><p>and this makes it much simpler to weaken tokens.</p>
<p>In fact, in CAF if you have a valid token you can always request a weaker
one regardless of who you are. Providing a service to manage user tokens
becomes trivial.</p>
<p>The meet (^) operator is just simply set intersection for each of the
 constraints:</p>
<pre class="prettyprint source"><code>        a^a = a
        a^* = a
        *^b = b
        a^b = 'empty' when (a !== b and a !== * and b !== *)</code></pre><p>and in the case of <code>expiresAfter</code>, pick the shortest deadline.</p>
<p>ACLs (Access Control Lists) are also expressed with the same semi-lattice,
using the meet operator for access checks:</p>
<pre class="prettyprint source"><code>    ALLOW if  ACL[i] ^ Token != empty    for some ACL[i] in ACL</code></pre><p>where the result of ^ is 'empty' if any of the constraints has an
 'empty' set.</p></div>
        

        
            















<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line21">line 21</a>
    </li></ul></dd>
    

    

    

    
</dl>


















        
    
    </div>

    

    

    

    

    

    

    

    
        <h3 class="subsection-title">Methods</h3>

        
            

    

    
    <h4 class="name" id="decode"><span class="type-signature"></span>decode<span class="signature">(tokenStr)</span><span class="type-signature"> &rarr; {caf.token}</span></h4>
    

    



<div class="description">
    <p>Decode a token without doing any checks. This is sometimes useful to choose
a public key for validation.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>tokenStr</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>


            
            </td>

            

            

            <td class="description last"><p>A string encoding a token.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line298">line 298</a>
    </li></ul></dd>
    

    

    

    
</dl>













<h5>Returns:</h5>

        
<div class="param-desc">
    <p>An untrusted token that has NOT been validated.</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">caf.token</span>


    </dd>
</dl>

    





        
            

    

    
    <h4 class="name" id="lessOrEqual"><span class="type-signature"></span>lessOrEqual<span class="signature">(t1, t2)</span><span class="type-signature"> &rarr; {boolean}</span></h4>
    

    



<div class="description">
    <p>Whether for tokens t1 and t2, t1 &lt;= t2.</p>
<p>Note that <code>null</code> represents the empty token, and <code>null &lt;= t2 for all t2</code>.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>t1</code></td>
            

            <td class="type">
            
                
<span class="param-type">caf.token</span>


            
            </td>

            

            

            <td class="description last"><p>A token to compare.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>t2</code></td>
            

            <td class="type">
            
                
<span class="param-type">caf.token</span>


            
            </td>

            

            

            <td class="description last"><p>A token to compare.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line200">line 200</a>
    </li></ul></dd>
    

    

    

    
</dl>











<h5>Throws:</h5>

        

<dl>
    <dt>
        <div class="param-desc">
        <p>Malformed token.</p>
        </div>
    </dt>
    <dd></dd>
    <dt>
        <dl>
            <dt>
                Type
            </dt>
            <dd>
                
<span class="param-type">Error</span>


            </dd>
        </dl>
    </dt>
    <dd></dd>
</dl>


    


<h5>Returns:</h5>

        
<div class="param-desc">
    <p>t1 &lt;= t2</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">boolean</span>


    </dd>
</dl>

    





        
            

    

    
    <h4 class="name" id="meet"><span class="type-signature"></span>meet<span class="signature">(t1, t2)</span><span class="type-signature"> &rarr; {caf.token|null}</span></h4>
    

    



<div class="description">
    <p>'Meet' (^)  operation of two tokens. Performs set intersection for each
constraint, and if any resulting constraint is empty it returns <code>null</code>, the
 empty token.</p>
<p> A missing constraint is assumed to be <code>*</code>, i.e., all the elements in the
 set.</p>
<p> Intersection of <code>expiresAfter</code> uses time intervals.</p>
<p> There is no validation of the tokens or signing of the result.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>t1</code></td>
            

            <td class="type">
            
                
<span class="param-type">caf.token</span>


            
            </td>

            

            

            <td class="description last"><p>A token to combine with the 'meet' operator.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>t2</code></td>
            

            <td class="type">
            
                
<span class="param-type">caf.token</span>


            
            </td>

            

            

            <td class="description last"><p>A token to combine with the 'meet' operator.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line110">line 110</a>
    </li></ul></dd>
    

    

    

    
</dl>













<h5>Returns:</h5>

        
<div class="param-desc">
    <p>Null if the resulting set is empty or an unsigned
 token payload with 't1^t2'.</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">caf.token</span>
|

<span class="param-type">null</span>


    </dd>
</dl>

    





        
            

    

    
    <h4 class="name" id="newPayload"><span class="type-signature"></span>newPayload<span class="signature">(appPublisher<span class="signature-attributes">opt</span>, appLocalName<span class="signature-attributes">opt</span>, caOwner<span class="signature-attributes">opt</span>, caLocalName<span class="signature-attributes">opt</span>, durationInSec<span class="signature-attributes">opt</span>)</span><span class="type-signature"> &rarr; {caf.token}</span></h4>
    

    



<div class="description">
    <p>Constructor for a new token or acl element payload.</p>
<p>The type of caf.token is</p>
<pre class="prettyprint source"><code> {appPublisher: string=, appLocalName:string=,
  caOwner: string=, caLocalName: string=, expiresAfter: string=}</code></pre>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        
        <th>Attributes</th>
        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>appPublisher</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>


            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>Publisher of the app hosting CAs.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>appLocalName</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>


            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>Name of the app in the 'appPublisher' context.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>caOwner</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>


            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>Owner of the CA.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>caLocalName</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>


            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>Name of the CA in the owner's context.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>durationInSec</code></td>
            

            <td class="type">
            
                
<span class="param-type">number</span>


            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>Time in seconds from 'now' till token expires.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line350">line 350</a>
    </li></ul></dd>
    

    

    

    
</dl>











<h5>Throws:</h5>

        

<dl>
    <dt>
        <div class="param-desc">
        <p>when input is malformed.</p>
        </div>
    </dt>
    <dd></dd>
    <dt>
        <dl>
            <dt>
                Type
            </dt>
            <dd>
                
<span class="param-type">Error</span>


            </dd>
        </dl>
    </dt>
    <dd></dd>
</dl>


    


<h5>Returns:</h5>

        
<div class="param-desc">
    <p>A token or acl element payload.</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">caf.token</span>


    </dd>
</dl>

    





        
            

    

    
    <h4 class="name" id="satisfyACL"><span class="type-signature"></span>satisfyACL<span class="signature">(acl, token)</span><span class="type-signature"> &rarr; {boolean}</span></h4>
    

    



<div class="description">
    <p>Checks whether a valid token satisfies an ACL (Access control List).</p>
<p>Inefficient with many ACLs. See <a href="module-caf_security_rules.html">module:caf_security/rules</a> for a
recommended alternative.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>acl</code></td>
            

            <td class="type">
            
                
<span class="param-type">Array.&lt;caf.token></span>
|

<span class="param-type">caf.token</span>


            
            </td>

            

            

            <td class="description last"><p>An ACL formed with one or an array
 of constraints using a token format.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>token</code></td>
            

            <td class="type">
            
                
<span class="param-type">caf.token</span>


            
            </td>

            

            

            <td class="description last"><p>A previously validated token to check 'acl'.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line319">line 319</a>
    </li></ul></dd>
    

    

    

    
</dl>













<h5>Returns:</h5>

        
<div class="param-desc">
    <p>True if satisfies at least one element of the ACL.</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">boolean</span>


    </dd>
</dl>

    





        
            

    

    
    <h4 class="name" id="sign"><span class="type-signature"></span>sign<span class="signature">(token, privKey)</span><span class="type-signature"> &rarr; {string}</span></h4>
    

    



<div class="description">
    <p>Signs a token.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>token</code></td>
            

            <td class="type">
            
                
<span class="param-type">caf.token</span>


            
            </td>

            

            

            <td class="description last"><p>Token to sign.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>privKey</code></td>
            

            <td class="type">
            
                
<span class="param-type">Object</span>


            
            </td>

            

            

            <td class="description last"><p>Private key for signing.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line219">line 219</a>
    </li></ul></dd>
    

    

    

    
</dl>











<h5>Throws:</h5>

        

<dl>
    <dt>
        <div class="param-desc">
        <p>Cannot sign.</p>
        </div>
    </dt>
    <dd></dd>
    <dt>
        <dl>
            <dt>
                Type
            </dt>
            <dd>
                
<span class="param-type">Error</span>


            </dd>
        </dl>
    </dt>
    <dd></dd>
</dl>


    


<h5>Returns:</h5>

        
<div class="param-desc">
    <p>A serialized signed token.</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">string</span>


    </dd>
</dl>

    





        
            

    

    
    <h4 class="name" id="similar"><span class="type-signature"></span>similar<span class="signature">(t1, t2, ignoreExpires)</span><span class="type-signature"> &rarr; {boolean}</span></h4>
    

    



<div class="description">
    <p>Deep equality of two tokens ignoring fields that are not constraints.</p>
<p>Note that <code>null</code> represents the empty token.</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>t1</code></td>
            

            <td class="type">
            
                
<span class="param-type">caf.token</span>


            
            </td>

            

            

            <td class="description last"><p>A token to compare.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>t2</code></td>
            

            <td class="type">
            
                
<span class="param-type">caf.token</span>


            
            </td>

            

            

            <td class="description last"><p>A token to compare.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>ignoreExpires</code></td>
            

            <td class="type">
            
                
<span class="param-type">boolean</span>


            
            </td>

            

            

            <td class="description last"><p>True if we ignore the token expire date.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line168">line 168</a>
    </li></ul></dd>
    

    

    

    
</dl>













<h5>Returns:</h5>

        
<div class="param-desc">
    <p>t1 similarTo t2</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">boolean</span>


    </dd>
</dl>

    





        
            

    

    
    <h4 class="name" id="validate"><span class="type-signature"></span>validate<span class="signature">(tokenStr, pubKey)</span><span class="type-signature"></span></h4>
    

    



<div class="description">
    <p>Validates a token.</p>
<p>Checks signature, expire time, and string format (ASCII alphanumeric).</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>tokenStr</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>


            
            </td>

            

            

            <td class="description last"><p>A string with the encoded token.</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>pubKey</code></td>
            

            <td class="type">
            
                
<span class="param-type">Object</span>


            
            </td>

            

            

            <td class="description last"><p>A public key to validate the token</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line270">line 270</a>
    </li></ul></dd>
    

    

    

    
</dl>











<h5>Throws:</h5>

        

<dl>
    <dt>
        <div class="param-desc">
        <p>Token does not validate</p>
        </div>
    </dt>
    <dd></dd>
    <dt>
        <dl>
            <dt>
                Type
            </dt>
            <dd>
                
<span class="param-type">Error</span>


            </dd>
        </dl>
    </dt>
    <dd></dd>
</dl>


    







        
            

    

    
    <h4 class="name" id="validUsername"><span class="type-signature"></span>validUsername<span class="signature">(username)</span><span class="type-signature"> &rarr; {boolean}</span></h4>
    

    



<div class="description">
    <p>Checks whether a username contains only valid characters (ASCII + numbers)</p>
</div>









    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>username</code></td>
            

            <td class="type">
            
                
<span class="param-type">string</span>


            
            </td>

            

            

            <td class="description last"><p>A username to check.</p></td>
        </tr>

    
    </tbody>
</table>






<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-source">Source:</dt>
    <dd class="tag-source"><ul class="dummy"><li>
        <a href="tokens.js.html">tokens.js</a>, <a href="tokens.js.html#line250">line 250</a>
    </li></ul></dd>
    

    

    

    
</dl>













<h5>Returns:</h5>

        
<div class="param-desc">
    <p>True if ok, false otherwise.</p>
</div>



<dl>
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">boolean</span>


    </dd>
</dl>

    





        
    

    

    
</article>

</section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-caf_security_aggregates.html">caf_security/aggregates</a></li><li><a href="module-caf_security_main.html">caf_security/main</a></li><li><a href="module-caf_security_plug_ca_security.html">caf_security/plug_ca_security</a></li><li><a href="module-caf_security_plug_security.html">caf_security/plug_security</a></li><li><a href="module-caf_security_proxy_security.html">caf_security/proxy_security</a></li><li><a href="module-caf_security_rules.html">caf_security/rules</a></li><li><a href="module-caf_security_tokens.html">caf_security/tokens</a></li><li><a href="module-caf_security_utils.html">caf_security/utils</a></li></ul><h3>Externals</h3><ul><li><a href="external-caf_components_gen_plug.html">caf_components/gen_plug</a></li><li><a href="external-caf_components_gen_plug_ca.html">caf_components/gen_plug_ca</a></li><li><a href="external-caf_components_gen_proxy.html">caf_components/gen_proxy</a></li><li><a href="external-caf_sharing.html">caf_sharing</a></li><li><a href="external-caf_sharing_AggregateMap.html">caf_sharing/AggregateMap</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat Feb 03 2018 00:52:35 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>