(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{V4CB:function(e,a,t){"use strict";t.r(a),t.d(a,"_frontmatter",(function(){return o})),t.d(a,"default",(function(){return d}));var n=t("zLVn"),c=(t("q1tI"),t("7ljp")),s=t("dzoR"),o={},p=function(e){return function(a){return console.warn("Component "+e+" was not imported, exported, or provided by MDXProvider as global scope"),Object(c.b)("div",a)}},b=p("DocsSidebar"),m=p("DocsContent"),r=p("DocsArticle"),N=p("Link"),l=p("DocsSection"),u={_frontmatter:o},i=s.a;function d(e){var a=e.components,t=Object(n.a)(e,["components"]);return Object(c.b)(i,Object.assign({},u,t,{components:a,mdxType:"MDXLayout"}),Object(c.b)(b,{mdxType:"DocsSidebar"}),Object(c.b)(m,{mdxType:"DocsContent"},Object(c.b)(r,{id:"concepts",mdxType:"DocsArticle"},Object(c.b)("h1",null,"Concepts"),Object(c.b)("p",null,"If you prefer to get into coding quickly, read ",Object(c.b)(N,{to:"#cloud-assistant",mdxType:"Link"},"Cloud Assistant")," first, and then ",Object(c.b)(N,{to:"#install",mdxType:"Link"},"Install")," and ",Object(c.b)(N,{to:"#headless-example",mdxType:"Link"},"First App"),"."),Object(c.b)("p",null,"To see the big picture first, keep on reading..."),Object(c.b)(l,{id:"components",mdxType:"DocsSection"},Object(c.b)("h2",null,"Components"),Object(c.b)("p",null,"In ",Object(c.b)("em",{parentName:"p"},"Caf.js")," we build ",Object(c.b)("strong",{parentName:"p"},"everything")," with hierarchies of components."),Object(c.b)("p",null,"Our component model was inpired by the ",Object(c.b)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/SmartFrog"},"SmartFrog Framework")," and the ",Object(c.b)("a",{parentName:"p",href:"https://erlang.org"},"Erlang/OTP")," libraries."),Object(c.b)("p",null,"Unless you are writing plugins, or reusing the component framework for something else, it is unlikely that you will write components from scratch. But if you are curious, you can see how ",Object(c.b)(N,{to:"../../apis/#caf_components",mdxType:"Link"},"here"),"."),Object(c.b)("p",null,"This section is all about using existing ones."),Object(c.b)("h4",null,"Asynchronous Creation"),Object(c.b)("p",null,"A component is created with an ",Object(c.b)("strong",{parentName:"p"},"asynchronous factory method"),". During component construction we can, for example, look up properties in ",Object(c.b)("em",{parentName:"p"},"Redis"),", and never block the main loop. With factory methods we can swap implementations without modifying the code."),Object(c.b)("p",null,"Even though component construction is asynchronous, ",Object(c.b)("em",{parentName:"p"},"Caf.js")," builds a hierarchy of components with a ",Object(c.b)("strong",{parentName:"p"},"deterministic order"),". A parent component is only inserted in its parent context ",Object(c.b)("strong",{parentName:"p"},"after")," its children are created in ",Object(c.b)("strong",{parentName:"p"},"left to right")," order. When the hierarchy is destroyed, the order is reversed. The topmost component is special, it is always there."),Object(c.b)("p",null,"Dependencies between components are respected by controlling creation order."),Object(c.b)("h4",null,"Supervision Trees"),Object(c.b)("p",null,"A parent component periodically checks the health of its children. If one is missing, or in a failed state, it takes one of these three recovery actions:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Shutdown remaining children in reverse order, and then restart them all."),Object(c.b)("li",{parentName:"ul"},"Restart only the missing child."),Object(c.b)("li",{parentName:"ul"},"Ignore the failure.")),Object(c.b)("p",null,"What if the component keeps failing? Its parent component eventually fails, and the fault bubbles up. If it reaches the top component, the process exits, and ",Object(c.b)("em",{parentName:"p"},"Kubernetes")," restarts the container somewhere else."),Object(c.b)("p",null,"No more zombie containers due to ",Object(c.b)("strong",{parentName:"p"},"shallow")," health checking!"),Object(c.b)("h4",null,"How to Navigate the Hierarchy?"),Object(c.b)("p",null,"Every component has a reference, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$"),", to a context shared with its siblings. Components register with a name, which is unique in that context. For example, if component ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo")," is created before sibling component ",Object(c.b)("code",{parentName:"p",className:"language-text"},"bar"),", ",Object(c.b)("code",{parentName:"p",className:"language-text"},"bar")," can access ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo")," with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.foo")),Object(c.b)("p",null,"What about components that are not siblings? Every context has a reference ",Object(c.b)("code",{parentName:"p",className:"language-text"},"_")," to the topmost component that is allowed to see. Children of this component can be accessed with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$._.$"),". For example, the logger component is the first child of the topmost component, visible to others as ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$._.$.log"),"."),Object(c.b)("p",null,"Application code is not allowed to navigate the internal hierarchy. Instead, security proxies to internal components populate ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$"),", and you never use ",Object(c.b)("code",{parentName:"p",className:"language-text"},"_"),". For example, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.log")," is a reference to the logger security proxy, that internally finds the real logger component in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"$._.$.log"),"."),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Caf.js")," internals are written in a functional style, hiding these private references in closures."),Object(c.b)("h4",null,"Describing Hierarchies with JSON"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"json"},Object(c.b)("pre",{parentName:"div",className:"language-json"},Object(c.b)("code",{parentName:"pre",className:"language-json"},Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"name"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"top"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"module"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"caf_components#supervisor"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"description"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"Supervisor for this app."'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"env"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token property"},'"logLevel"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"process.env.LOG_LEVEL||DEBUG"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n        ",Object(c.b)("span",{parentName:"code",className:"token property"},'"somethingElse"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"process.env.SOMETHING_ELSE||{\\"goo\\":2}"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n        ",Object(c.b)("span",{parentName:"code",className:"token property"},'"maxRetries"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"process.env.MAX_RETRIES||10"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n        ",Object(c.b)("span",{parentName:"code",className:"token property"},'"retryDelay"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"process.env.RETRY_DELAY||1000"'),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"components"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"name"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"log"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"module"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"caf_components#plug_log"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"description"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"Logger service"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"env"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n                ",Object(c.b)("span",{parentName:"code",className:"token property"},'"logLevel"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"$._.env.logLevel"'),"\n            ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"name"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"foo"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"module"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"./myApp"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"description"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"My app component"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"env"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n                ",Object(c.b)("span",{parentName:"code",className:"token property"},'"somethingElse"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"$._.env.somethingElse"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n                ",Object(c.b)("span",{parentName:"code",className:"token property"},'"message"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"Hello"'),"\n            ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")))),Object(c.b)("p",null,"The JSON file above, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"components.json"),",  describes a parent component ",Object(c.b)("code",{parentName:"p",className:"language-text"},"top")," with two child components ",Object(c.b)("code",{parentName:"p",className:"language-text"},"log")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo"),". Since ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo")," is created after sibling ",Object(c.b)("code",{parentName:"p",className:"language-text"},"log"),", it can safely find the logger with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.log"),"."),Object(c.b)("p",null,"The attribute ",Object(c.b)("code",{parentName:"p",className:"language-text"},"module")," identifies the factory method that instantiates the component. For example, for ",Object(c.b)("code",{parentName:"p",className:"language-text"},"caf_components#supervisor")," the factory method will be found with ",Object(c.b)("code",{parentName:"p",className:"language-text"},'module.require("caf_components").supervisor'),"."),Object(c.b)("p",null,"The attribute ",Object(c.b)("code",{parentName:"p",className:"language-text"},"env")," specifies initialization properties for the component. Three examples of property value types:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"Hello"),": a JSON serialized type. If JSON parsing fails, we assume it was a string that was not quoted."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"process.env.LOG_LEVEL||DEBUG"),": a system environment property. If ",Object(c.b)("code",{parentName:"li",className:"language-text"},"LOG_LEVEL")," is not set, we use ",Object(c.b)("code",{parentName:"li",className:"language-text"},"DEBUG")," as default. Resolved values are always JSON serialized types."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"$._.env.logLevel"),": a reference to the topmost ",Object(c.b)("code",{parentName:"li",className:"language-text"},"env"),". In this case it resolves to ",Object(c.b)("code",{parentName:"li",className:"language-text"},"process.env.LOG_LEVEL||DEBUG"),".")),Object(c.b)("p",null,"To create an instance of the hierarchy, ",Object(c.b)("em",{parentName:"p"},"Caf.js"),"  merges the instantiation properties with the topmost ",Object(c.b)("code",{parentName:"p",className:"language-text"},"env"),". And this happens before resolving any other properties."),Object(c.b)("p",null,"Combined with linking, we can configure internal components without knowing the internal structure of the description."),Object(c.b)("h4",null,"Patching JSON Descriptions"),Object(c.b)("p",null,"In most cases we do not create descriptions from scratch. We use a base description as a template, and change a few attributes, or add/delete some components."),Object(c.b)("p",null,"To change ",Object(c.b)("code",{parentName:"p",className:"language-text"},"components.json")," create a new description called ",Object(c.b)("code",{parentName:"p",className:"language-text"},"components++.json")," that will be merged with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"components.json"),"."),Object(c.b)("p",null,"For example, to modify the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"message")," property"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"json"},Object(c.b)("pre",{parentName:"div",className:"language-json"},Object(c.b)("code",{parentName:"pre",className:"language-json"},Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"name"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"top"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"components"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"name"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"foo"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"env"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"                ",Object(c.b)("span",{parentName:"span",className:"token property"},'"message"'),Object(c.b)("span",{parentName:"span",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"span",className:"token string"},'"Goodbye"')),"            ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")))),Object(c.b)("p",null,"or set ",Object(c.b)("code",{parentName:"p",className:"language-text"},"module")," to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"null")," to delete the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo")," component"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"json"},Object(c.b)("pre",{parentName:"div",className:"language-json"},Object(c.b)("code",{parentName:"pre",className:"language-json"},Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"name"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"top"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"components"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"name"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"foo"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token property"},'"module"'),Object(c.b)("span",{parentName:"span",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"span",className:"token null keyword"},"null")),"        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")))),Object(c.b)("p",null,"or to insert a new component ",Object(c.b)("code",{parentName:"p",className:"language-text"},"bar")," before ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo")),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"json"},Object(c.b)("pre",{parentName:"div",className:"language-json"},Object(c.b)("code",{parentName:"pre",className:"language-json"},Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"name"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"top"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token property"},'"components"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"{")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token property"},'"name"'),Object(c.b)("span",{parentName:"span",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"span",className:"token string"},'"log"')),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")),"        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"name"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"bar"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"module"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"./myApp"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"description"'),Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"My other app component"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n            ",Object(c.b)("span",{parentName:"code",className:"token property"},'"env"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n                ",Object(c.b)("span",{parentName:"code",className:"token property"},'"somethingElse"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"$._.env.somethingElse"'),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n                ",Object(c.b)("span",{parentName:"code",className:"token property"},'"message"')," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token string"},'"Whatever"'),"\n            ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")))),Object(c.b)("p",null,'Note the "touch" operation to indicate the insertion position in the array. Insertion of a component with a new key is right after the last array operation.')),Object(c.b)(l,{id:"cloud-assistant",mdxType:"DocsSection"},Object(c.b)("h2",null,"Cloud Assistant"),Object(c.b)("p",null,"The Cloud Assistant (CA) is the main abstraction provided by the ",Object(c.b)("em",{parentName:"p"},"Caf.js")," framework. The foundation of a CA is the Actor Model. ",Object(c.b)("em",{parentName:"p"},"Caf.js")," makes actors transactional, and mediates access to the external world with transactional plugins."),Object(c.b)("p",null,"The internal state of a CA is ",Object(c.b)("strong",{parentName:"p"},"always")," consistent with its external commitments, even after server failures."),Object(c.b)("p",null,"The  ",Object(c.b)(N,{to:"/orchestration#transactional-actors",mdxType:"Link"},"Reliable Service Orchestration")," section described the Actor Model, our transactional plugins, the CA checkpointing implementation with ",Object(c.b)("em",{parentName:"p"},"Redis"),", and the recovery strategies after a failure."),Object(c.b)("p",null,"In this section we focus on what all this means for your code."),Object(c.b)("h4",null,"Hello World"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'getCounter()'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"The file ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca_methods.js")," is the entry point for your application. You can change the name of this file by changing configuration properties, but it can be confusing for others reading your code if you do so."),Object(c.b)("p",null,"This file exports a mixin of methods for your CA using the property ",Object(c.b)("code",{parentName:"p",className:"language-text"},"methods"),".\nThere are two types of methods:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Internal methods")," called by the framework. They always have a prefix name ",Object(c.b)("code",{parentName:"li",className:"language-text"},"__ca_"),". For example, ",Object(c.b)("code",{parentName:"li",className:"language-text"},"__ca_init__()")," will be called by ",Object(c.b)("em",{parentName:"li"},"Caf.js")," the first time the CA is initialized."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"External methods")," called by remote clients. They are all the others. For example, ",Object(c.b)("code",{parentName:"li",className:"language-text"},"getCounter()")," can be invoked by an authorized client to know the current counter value.")),Object(c.b)("p",null,"Methods are ",Object(c.b)("code",{parentName:"p",className:"language-text"},"async")," methods, and always return an array. This array represents a tuple error-value, where an optional application-level error is the first element of the array, and an optional second element is the value returned to the client when there are no errors."),Object(c.b)("p",null,"A ",Object(c.b)("em",{parentName:"p"},"Caf.js")," application loads with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"caf.init()"),". We pass as an argument the current ",Object(c.b)("code",{parentName:"p",className:"language-text"},"module")," object,  to facilitate finding descriptions and plugins that share directory with the file ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca_methods.js"),". The ",Object(c.b)("em",{parentName:"p"},"Caf.js")," loader maintains a list of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"module")," objects, and tries them in sequence until it finds the resource."),Object(c.b)("p",null,"A CA keeps internal state in two properties:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"this.state"),": Checkpointed state, needs to be JSON-serializable, and always modified within a transaction."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"this.scratch"),": Non-transactional state, not checkpointed, but can be anything. Typically used for caching data, or debugging.")),Object(c.b)("p",null,"Think of a CA as a sealed object.  Never add state outside these two properties."),Object(c.b)("p",null,"Access plugins with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$"),". For example, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.log")," returns a proxy to the logger service, and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.log.debug()")," adds a debug message to the log.\nTo configure plugins ",Object(c.b)("em",{parentName:"p"},"Caf.js")," uses JSON descriptions, as discussed in ",Object(c.b)(N,{to:"#headless-example",mdxType:"Link"},"First App"),"."),Object(c.b)("h4",null,"Request Serialization"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," util ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'util'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," setTimeoutPromise ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," util",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"promisify"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"setTimeout",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"increment"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"await")," ",Object(c.b)("span",{parentName:"span",className:"token function"},"setTimeoutPromise"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token number"},"1000"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"A CA serializes requests with a queue. Before processing the next request in the queue, it ensures that the current one has finished, even if that requires waiting for the completion of several asynchronous steps."),Object(c.b)("p",null,"Serialization does not reduce performance. There could be thousands of CAs in a single process, and blocking one of them does not affect the others, since each CA has its own queue, and its state is private."),Object(c.b)("p",null,"And serialization in ",Object(c.b)("em",{parentName:"p"},"Caf.js")," is a ",Object(c.b)("strong",{parentName:"p"},"cluster-wide")," property. Servers can fail, with hundreds of processes spread across many servers running your app, but CA requests will always be processed one after another."),Object(c.b)("p",null,"What is the benefit of serialization?"),Object(c.b)("p",null,"Serialization enables a ",Object(c.b)("strong",{parentName:"p"},"much simpler")," programming abstraction."),Object(c.b)("p",null,"Let's assume that ",Object(c.b)("code",{parentName:"p",className:"language-text"},"increment()")," is expected to return a unique value each time is called."),Object(c.b)("p",null,"The innocent looking ",Object(c.b)("code",{parentName:"p",className:"language-text"},"increment()")," method would have a subtle bug if it were implemented in the same way with existing web application frameworks, such as ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Express"),"."),Object(c.b)("p",null,"If one request is waiting for the timeout, and another one starts executing, the second one will also update ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.state.counter"),". When the first one ends the timeout, it will return the current value of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.state.counter"),", which was updated by the second request. Now both return the same value."),Object(c.b)("p",null,"And races tend to break things when the system is under heavy load, in production, not when doing simple testing. With the convenience of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"async/await")," primitives in modern ",Object(c.b)("em",{parentName:"p"},"JavaScript"),", introducing races is so much easier..."),Object(c.b)("h4",null,"Error Handling"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," assert ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'assert'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"increment"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"n"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"n ",Object(c.b)("span",{parentName:"code",className:"token operator"},"<")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"span",className:"token class-name"},"Error"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'Only increment!'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"else")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token function"},"assert"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token operator"},"!"),Object(c.b)("span",{parentName:"span",className:"token function"},"isNaN"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"There are two kinds of errors:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Application-level")," errors that your code knows best how to handle. These are errors returned in the first element of the array."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Unrecoverable")," errors, mostly bugs, which ",Object(c.b)("em",{parentName:"li"},"Caf.js")," does not expect your code to handle gracefully. These are uncaught exceptions thrown by your code.")),Object(c.b)("p",null,"The client library handles these two types of errors very differently, as we will see ",Object(c.b)(N,{to:"#client",mdxType:"Link"},"soon"),"."),Object(c.b)("p",null,"But a CA always aborts the transaction associated with the request. This means that any changes to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.state")," are reversed, and all the transactional plugins will also abort, avoiding any external side-effects."),Object(c.b)("p",null,"Again, this enables a ",Object(c.b)("strong",{parentName:"p"},"much simpler")," programming abstraction."),Object(c.b)("p",null,"In the example above, a negative increment is handled as an application-level error, because we assume the client code could do something about it, like suggesting a different service that can decrement."),Object(c.b)("p",null,"What happens if the input ",Object(c.b)("code",{parentName:"p",className:"language-text"},"n")," is the string ",Object(c.b)("code",{parentName:"p",className:"language-text"},"oops"),"? The comparison with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"0")," is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"false"),", and we get a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"NaN")," after the addition. The assertion throws, creating an unrecoverable error."),Object(c.b)("p",null,"In this case a traditional web application framework would have corrupted the state of this CA forever. With millions of cheap CAs, expected to run for years with minimal supervision, manual recovery is not in the menu. This is a disaster."),Object(c.b)("p",null,"Note that we are ",Object(c.b)("strong",{parentName:"p"},"not")," encouraging to delay input validation, or promote other bad programming habits, but mistakes happen, and it is a good idea to have a safety net."),Object(c.b)("h4",null,"External Consistency"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," assert ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'assert'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"increment"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"session",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"notify"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"<=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"100"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"else")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Error"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Limit exceeded'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"The internal state of a CA is always consistent with its external commitments."),Object(c.b)("p",null,"This sounds a bit abstract, let's give an example to clarify what we mean."),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Caf.js")," uses a transactional plugin, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"session"),", to send notifications to clients. We will talk about sessions in the ",Object(c.b)(N,{to:"#autonomous",mdxType:"Link"},"next")," section but, for this discussion, it is just a plugin with external side-effects."),Object(c.b)("p",null,"Calling ",Object(c.b)("code",{parentName:"p",className:"language-text"},"increment()")," adds one to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.state.counter"),", and sends a notification with the new counter."),Object(c.b)("p",null,"What happens when the counter exceeds ",Object(c.b)("code",{parentName:"p",className:"language-text"},"100"),"? It returns an error, aborting the transaction, and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.state.counter")," rolls back to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"100"),"."),Object(c.b)("p",null,"But what about the notification? The external world saw that the internal state is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"101"),", but that is inconsistent with the current value of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"100"),"."),Object(c.b)("p",null,"And this is also a problem for smaller values. If we send the notification, and then the server crashes ",Object(c.b)("strong",{parentName:"p"},"before")," checkpointing, the state update is lost forever. And the world saw the new value."),Object(c.b)("p",null,"In most frameworks the missile has already launched, and there is not much we can do about it."),Object(c.b)("p",null,"But in ",Object(c.b)("em",{parentName:"p"},"Caf.js")," we use transactional plugins to externalize state changes. For example, when we call ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.session.notify()"),", the plugin just appends to a log our intent to send the notification, but it does ",Object(c.b)("strong",{parentName:"p"},"not")," sent it. Only when the request commits, and the log of actions and the state changes have been checkpointed, the notification is sent."),Object(c.b)("p",null,"Transactional plugins ",Object(c.b)("strong",{parentName:"p"},"compose")," using a two-phase commit protocol. We can mix plugins from different providers, and commit them atomically, or abort all of them if one cannot commit. But this happens behind the scenes, application code does not see this complexity."),Object(c.b)("p",null,"And yet again, this enables a ",Object(c.b)("strong",{parentName:"p"},"much simpler")," programming abstraction."),Object(c.b)("h4",null,"Learn More"),Object(c.b)("p",null,"A CA can do much more. Update the schema of its internal state safely. Read application properties from the environment. Customize actions after hibernation."),Object(c.b)("p",null,"See the jsdoc documentation ",Object(c.b)(N,{to:"../../apis/#caf_ca",mdxType:"Link"},"here"),".")),Object(c.b)(l,{id:"autonomous",mdxType:"DocsSection"},Object(c.b)("h2",null,"Autonomous Computation"),Object(c.b)("p",null,"In the introduction to ",Object(c.b)(N,{to:"../../autonomous",mdxType:"Link"},"Autonomous Computation")," we described a few use cases, and gave an overview of notifications in ",Object(c.b)("em",{parentName:"p"},"Caf.js"),"."),Object(c.b)("p",null,"This section is all about implementing these ideas in your applications."),Object(c.b)("h4",null,"Sessions"),Object(c.b)("p",null,"When spawning a long term activity in the Cloud, it is crucial to manage notifications for offline clients. This means queueing them in the Cloud until clients are ready to read them. But it also means ensuring that ",Object(c.b)("em",{parentName:"p"},"Caf.js")," does not run out of memory with a leaky queue. And when the client is back online, low latency interaction is a must."),Object(c.b)("p",null,"What is the best strategy to manage notification queues?"),Object(c.b)("p",null,"It depends. Limiting queue size is a given, but deciding what to evict is not. Shall we stop queueing new notifications, or remove the old ones, or just keep the last one, or delete redundant ones, or ..."),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Caf.js")," sets some sensible limits, but it also makes the notification queues visible to application code. Your autonomous code can supervise the queues."),Object(c.b)("p",null,"And a notification queue has a name. A simple name that matches the session name chosen by the client. Swap client devices, type this name, and your notifications will follow you. Or use a different name per device to keep them separately."),Object(c.b)("p",null,"Let's show an example"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"SESSION")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'admin'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"session",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"limitQueue"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token number"},"1"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token constant"},"SESSION"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"span",className:"token function"},"__ca_pulse__"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"{")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"1"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"%")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"props",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"divisor ",Object(c.b)("span",{parentName:"span",className:"token operator"},"===")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"0"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"{")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"session",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"notify"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token constant"},"SESSION"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"}")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")),"    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"increment"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"To make your CA autonomous, implement the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_pulse__()")," method, and the runtime will call it periodically."),Object(c.b)("p",null,"How often? The default is every 2 seconds, but you can change that in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"framework++.json"),". Just modify the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"interval")," property of the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cron_pulser")," component."),Object(c.b)("p",null,"In this case ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_pulse__()")," increments a counter, and whenever the counter is a multiple of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"divisor"),", it sends a notification to a queue named ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin"),". Note that ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.props.divisor")," is a property configured in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca++.json"),"."),Object(c.b)("p",null,"Calling ",Object(c.b)("code",{parentName:"p",className:"language-text"},"limitQueue()")," overrides the default configuration, and the queue just keeps the last notification."),Object(c.b)("p",null,"When a client connects with a session named ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin"),", it first receives this last notification. And then, it keeps receiving new notifications in real-time until it disconnects."),Object(c.b)("h5",null,"Notification Groups"),Object(c.b)("p",null,"Delivering a notification removes it from the queue. When several clients need to see the same notification, use multiple queues and duplicate notifications."),Object(c.b)("p",null,"What if the number of clients is not known a priori? Queues are created on-demand, and we address them with regular expressions."),Object(c.b)("p",null,"Let's see an example."),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"span",className:"token constant"},"SESSION")," ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token regex"},Object(c.b)("span",{parentName:"span",className:"token regex-delimiter"},"/"),Object(c.b)("span",{parentName:"span",className:"token regex-source language-regex"},"^admin"),Object(c.b)("span",{parentName:"span",className:"token regex-delimiter"},"/")),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"exports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_pulse__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"%")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"props",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"divisor ",Object(c.b)("span",{parentName:"code",className:"token operator"},"===")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"session",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"notify"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token constant"},"SESSION"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"When a client calls ",Object(c.b)("code",{parentName:"p",className:"language-text"},"getCounter()"),", its session name will be added to the notification group, if it starts with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin"),". A name suffix could be random, or based on the username, or chosen by the user. The goal is to avoid name collisions with other clients. After being offline, the client could reuse the session name to receive the pending notifications."),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Caf.js")," could run out of memory if it cannot control the number of sessions in the notification group. There is a system-wide property to do that, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"maxSessions"),", that can be changed in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca++.json"),", or through environment properties. Similarly, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"maxMessages")," will limit the maximum number of messages in any queue."),Object(c.b)("p",null,"When the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"maxSessions")," limit has been reached, any session that is offline, and has not set a custom limit of messages, can be garbage collected. This means that your pending notifications may not be there when you reconnect."),Object(c.b)("h4",null,"Learn More"),Object(c.b)("p",null,"A persistent session can guarantee that an stateless client recovers gracefully after a crash, avoiding duplicated requests. See ",Object(c.b)(N,{to:"../../apis/#caf_session",mdxType:"Link"},"Persistent Session")," for details, and the app ",Object(c.b)("a",{parentName:"p",href:"https://github.com/cafjs/caf_hellofail.git"},"HelloFail")," for an example.")),Object(c.b)(l,{id:"client",mdxType:"DocsSection"},Object(c.b)("h2",null,"Client Library"),Object(c.b)("p",null,"The ",Object(c.b)("em",{parentName:"p"},"Caf.js"),"  ",Object(c.b)(N,{to:"../../apis/#caf_cli",mdxType:"Link"},"client library")," is a tiny library that just needs web socket support. It works in the browser, in the Cloud, with your scripts, and with embedded devices. Currently JavaScript-only, but more languages will be added soon."),Object(c.b)("p",null,"The goal of this library is to create an authenticated session with a CA, and then provide both a request-response and a notification model, using a common abstraction."),Object(c.b)("h4",null,"Authentication"),Object(c.b)("p",null,"JSON Web Tokens (JWTs) embedded in URLs is the main mechanism for client authentication. Tokens are self-describing, typically short-lived, and signed with the private key of the ",Object(c.b)("a",{parentName:"p",href:"https://github.com/cafjs/caf_accounts.git"},"Accounts")," service. Its corresponding public key is always available, and apps validate tokens locally."),Object(c.b)("p",null,"Tokens form a semi-lattice, making it easier to weaken them on-demand. By scoping a token to a particular app, owner, or CA name, we eliminate man-in-the-middle attacks, and reduce the damage of a compromised token."),Object(c.b)("p",null,"The ",Object(c.b)("a",{parentName:"p",href:"https://github.com/cafjs/caf_launcher.git"},"Launcher")," app manages your tokens in the background, with CAs, renewing and weakening them as needed. It provides Single Sign-On (SSO) for all your CAs. Before redirecting to another app, it just adds the correct token to the URL."),Object(c.b)("p",null,"This means that the client library has very little work to do. In most cases, it just extracts the token from a fragment in the URL, and sends it to the CA for validation using TLS."),Object(c.b)("p",null,"What happens if there is no valid token in the URL?"),Object(c.b)("p",null,"The client library calls a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"TokenFactory")," hook method that will create the token based on other credentials, for example, your username and password for the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Accounts")," service."),Object(c.b)("p",null,"The client script in our ",Object(c.b)(N,{to:"#headless-example",mdxType:"Link"},"first app")," shows how to use the SRP ",Object(c.b)("code",{parentName:"p",className:"language-text"},"TokenFactory"),"."),Object(c.b)("p",null,"In the following examples the security plugin has been disabled."),Object(c.b)("h4",null,"Request-Response"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf_cli ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"caf_cli",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"span",className:"token constant"},"URL")," ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token string"},"'http://root-hello.vcap.me:3000/#from=foo-ca1&ca=foo-ca1'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," s ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"caf_cli",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"Session"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token constant"},"URL"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ns",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"onopen")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"try")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"let")," counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"await")," s",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"increment"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token number"},"7"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"getPromise"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        console",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"log"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"await")," s",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getPromise"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        console",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"log"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        s",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"close"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"catch")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token comment"},"// Application-level error"),"\n        s",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"close"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ns",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"onclose")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"err"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        console",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"log"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token template-string"},Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`"),Object(c.b)("span",{parentName:"span",className:"token string"},"Got exception "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"err",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        process",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"exit"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    console",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"log"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Done OK'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    process",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"exit"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"The script above first creates a session with CA ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo-ca1"),". There are two fields in the URL fragment, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"from")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca"),", and they are the same. This means that the client is acting as the ",Object(c.b)("strong",{parentName:"p"},"owner")," of this CA, and the CA will be created if needed. Most clients act as owners, and they always have full access. However, in order to claim a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"from")," origin, a matching authentication token (not shown) needs to be part of the URL."),Object(c.b)("p",null,"After creating the session the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"onopen")," handler gets called, and we can invoke remote methods on this CA. But there is some magic behind the scenes."),Object(c.b)("p",null,"CA methods ",Object(c.b)("code",{parentName:"p",className:"language-text"},"increment()")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"getCounter()")," become methods of session ",Object(c.b)("code",{parentName:"p",className:"language-text"},"s"),". The client library has downloaded some metadata from the server, and it has created local methods matching the CA remote methods. These local methods will do sanity checks on the arguments before forwarding requests."),Object(c.b)("p",null,"What about error handling?"),Object(c.b)("p",null,"As we discussed in the ",Object(c.b)(N,{to:"#cloud-assistant",mdxType:"Link"},"Cloud Assistant")," section, there are two types of errors:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"An ",Object(c.b)("strong",{parentName:"li"},"Application-level")," error, i.e., the first element of the returned array, is used by the client library to reject the returned ",Object(c.b)("em",{parentName:"li"},"Promise"),". Therefore, ",Object(c.b)("code",{parentName:"li",className:"language-text"},"await")," will throw, and the error can be managed inline."),Object(c.b)("li",{parentName:"ul"},"An ",Object(c.b)("strong",{parentName:"li"},"Unrecoverable")," error, i.e., exceptions thrown by your CA code, will instead close the session, returning the error in the ",Object(c.b)("code",{parentName:"li",className:"language-text"},"onclose")," handler.")),Object(c.b)("p",null,"Just to confuse you, this example handles an application-level error by closing the session with it, a common pattern of simple scripts. But there is no need of closing the session, we could just continue."),Object(c.b)("p",null,"What happens if we call multiple methods on the session without ",Object(c.b)("code",{parentName:"p",className:"language-text"},"await"),"? The session has a local queue, and serializes requests. Some recoverable errors are also handled transparently by retrying the last request. If you want multiple concurrent requests, create multiple sessions. But remember that the CA will serialize them anyway..."),Object(c.b)("h4",null,"Notifications"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf_cli ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"caf_cli",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," util ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'util'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," setTimeoutPromise ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," util",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"promisify"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"setTimeout",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"span",className:"token constant"},"URL")," ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token string"},"'http://root-hello.vcap.me:3000/#session=admin&from=foo-ca1&ca=foo-ca1'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," s ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"caf_cli",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"Session"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token constant"},"URL"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ns",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"onopen")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"try")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"let")," counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"await")," s",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"increment"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token number"},"7"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getPromise"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        console",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"log"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"await")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"setTimeoutPromise"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token number"},"10000"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),"\n        s",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"close"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"catch")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token comment"},"// Application-level error"),"\n        s",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"close"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"s",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function-variable function"},"onmessage")," ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token parameter"},"msg"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"{")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," caf_cli",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"getMethodArgs"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),"msg",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token number"},"0"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    console",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"log"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token template-string"},Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`"),Object(c.b)("span",{parentName:"span",className:"token string"},"Got notification "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"counter",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`")),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},Object(c.b)("span",{parentName:"span",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"s",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"onclose")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"err"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        console",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"log"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token template-string"},Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`"),Object(c.b)("span",{parentName:"span",className:"token string"},"Got exception "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"err",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        process",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"exit"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    console",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"log"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Done OK'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    process",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"exit"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"Let's add notifications to our previous example. A couple of changes:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Provide a session name in the URL. We use the name ",Object(c.b)("code",{parentName:"li",className:"language-text"},"admin")," to match the queue name in the previous CA example. If missing, the default session name is ",Object(c.b)("code",{parentName:"li",className:"language-text"},"default"),"."),Object(c.b)("li",{parentName:"ul"},"Create an ",Object(c.b)("code",{parentName:"li",className:"language-text"},"onmessage")," handler that will receive each notification.")),Object(c.b)("p",null,"Using ",Object(c.b)("code",{parentName:"p",className:"language-text"},"getMethodArgs()")," we can extract the counter value from the notification."),Object(c.b)("h4",null,"Learn More"),Object(c.b)("p",null,"Why do we need ",Object(c.b)("code",{parentName:"p",className:"language-text"},"getPromise()"),"? Multi-method requests, that extend the scope of a transaction to a sequence of CA methods."),Object(c.b)("p",null,"And more... Encrypt messages end-to-end with Diffie-Hellman keys. Synchronize local time with the Cloud."),Object(c.b)("p",null,"See the ",Object(c.b)(N,{to:"../../apis/#caf_cli",mdxType:"Link"},"jsdoc")," for details.")),Object(c.b)(l,{id:"trusted-bus",mdxType:"DocsSection"},Object(c.b)("h2",null,"Trusted Bus"),Object(c.b)("p",null,"In the ",Object(c.b)(N,{to:"../../collaborative",mdxType:"Link"},"Collaborative Multi-tenancy")," overview, we talked about the importance of bootstrapping trust between users of one app, and how a ",Object(c.b)("em",{parentName:"p"},"Trusted Bus")," abstraction helped with that goal."),Object(c.b)("p",null,"A ",Object(c.b)("em",{parentName:"p"},"Trusted Bus")," mediates ",Object(c.b)("strong",{parentName:"p"},"internal")," interactions between users, authenticating requests, and enforcing access control policy at the target endpoints."),Object(c.b)("p",null,"The emphasis is on ",Object(c.b)("strong",{parentName:"p"},"internal"),". Within ",Object(c.b)("strong",{parentName:"p"},"one")," app."),Object(c.b)("p",null,"The client library is not designed for internal interactions between untrusted peers. Authentication tokens will be compromised. This could be fixed with public-key cryptography, but the performance hit, and key management complexity, makes it impractical."),Object(c.b)("p",null,"Can we authenticate requests without tokens, or other crypto?"),Object(c.b)("p",null,"Sure, if every possible request source is trusted, and requests in transit cannot be modified."),Object(c.b)("p",null,"The ",Object(c.b)("em",{parentName:"p"},"Caf.js Cloud")," configures Kubernetes network policy to do just that. The ",Object(c.b)("em",{parentName:"p"},"Node.js")," processes of your application live in their own network bubble, isolated from other apps."),Object(c.b)("p",null,"And application code does not directly access the network. Instead, it uses plugins that have been wrapped by security proxies. These proxies do not trust the application code, adding to each request the name of the CA that sends it."),Object(c.b)("p",null,"This makes it less likely that a bug in your application will compromise authentication. After all, your code does not do anything, and authentication is transparently handled by proxies."),Object(c.b)("p",null,"What about authorization?"),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Caf.js")," always performs an access control check at the destination, before calling  a CA method. It also makes the caller CA name visible, while the method executes, with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.security.getCallerFrom()"),"."),Object(c.b)("p",null,"But your code configures policy. And the rest of this section explains how."),Object(c.b)("h4",null,"Defaults"),Object(c.b)("p",null,"The default policy is ",Object(c.b)("strong",{parentName:"p"},"trust no one"),". The owner is the only one that can invoke methods on a CA."),Object(c.b)("p",null,"And allowed interactions are external-only, using the client library, with owner requests where the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"from")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca")," properties match, as described in the ",Object(c.b)(N,{to:"#client",mdxType:"Link"},"Client Library")," section."),Object(c.b)("p",null,"No ",Object(c.b)("em",{parentName:"p"},"Trusted Bus")," interaction."),Object(c.b)("p",null,"If nothing works, ",Object(c.b)("strong",{parentName:"p"},"check the security policy")," first..."),Object(c.b)("h4",null,"Simple Rules"),Object(c.b)("p",null,"Naming conventions simplify policy."),Object(c.b)("p",null,"In ",Object(c.b)("em",{parentName:"p"},"Caf.js")," naming is based on local namespaces.The name of a CA is always relative to its owner, for example, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo-ca1")," means the user ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo")," owns a CA named ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca1"),". The name of a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"SharedMap")," is always relative to the CA that owns it, for example, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo-ca1-friends"),". And so on..."),Object(c.b)("p",null,"It is easy to enforce and describe policies based on ownership."),Object(c.b)("p",null,"For example, to enable CAs with the same owner, using the ",Object(c.b)("em",{parentName:"p"},"Trusted Bus"),", to call the method ",Object(c.b)("code",{parentName:"p",className:"language-text"},"getCounter()")," on each other."),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," rule ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"security",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"newSimpleRule"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"(")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token string"},"'getCounter'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"security",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token constant"},"SELF")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"security",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"addRule"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),"rule",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'getCounter()'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"More examples."),Object(c.b)("p",null,"To open all the CA methods"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," rule ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"security",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"newSimpleRule"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"security",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token constant"},"SELF"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"or to enable CA with local name ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca3")," of my friend ",Object(c.b)("code",{parentName:"p",className:"language-text"},"joe"),", i.e., ",Object(c.b)("code",{parentName:"p",className:"language-text"},"joe-ca3"),"."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," rule ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"security",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"newSimpleRule"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'joe'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'ca3'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,'Note that to allow external interactions with the client library there is a "secret" method that also needs to be enabled, ',Object(c.b)("code",{parentName:"p",className:"language-text"},"__external_ca_touch__"),"."),Object(c.b)("p",null,"Prefer the ",Object(c.b)("em",{parentName:"p"},"Trusted Bus")," over external interaction. It is no longer your code making requests. There are dragons out there..."),Object(c.b)("h4",null,"Aggregate Rules"),Object(c.b)("p",null,"To describe a dynamic policy, potentially shared by many CAs, ",Object(c.b)("em",{parentName:"p"},"Caf.js")," uses a ",Object(c.b)("em",{parentName:"p"},"SharedMap"),"."),Object(c.b)("p",null,"A ",Object(c.b)("em",{parentName:"p"},"SharedMap"),"  is a replicated Distributed Data Structure (DDS) that can only be written by its owner. We describe ",Object(c.b)("em",{parentName:"p"},"SharedMap")," ",Object(c.b)(N,{to:"#sharedmap",mdxType:"Link"},"here"),"."),Object(c.b)("p",null,"For example, assuming that each owner has a CA named ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin")," that maintains policy for all its CAs:"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CA")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'admin'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_MAP")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'primaryACL'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"isAdmin")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"self"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," name ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," self",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_getName__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"splitName"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"name",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"===")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CA"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"primaryMap")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"self"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," name ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," self",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_getName__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"joinName"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"splitName"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"name",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CA"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_MAP"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token function"},"isAdmin"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"addWritableMap"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'acl'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_MAP"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"addReadOnlyMap"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"\n            ",Object(c.b)("span",{parentName:"code",className:"token string"},"'aclAgg'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"primaryMap"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"isAggregate",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token boolean"},"true"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," rule ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"security",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"newAggregateRule"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"\n            ",Object(c.b)("span",{parentName:"code",className:"token string"},"'getCounter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'aclAgg'"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"security",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"addRule"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"rule",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"changePolicy"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"principal",Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," isAllowed"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"isAdmin"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"isAllowed",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n                $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"acl",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"set"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"principal",Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token boolean"},"true"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"else")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n                $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"acl",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"delete"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"principal",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"else")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Error"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Not an admin'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'getCounter()'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"Each CA:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Finds the name of the ",Object(c.b)("em",{parentName:"li"},"SharedMap")," managed by the owner's ",Object(c.b)("code",{parentName:"li",className:"language-text"},"admin")," CA."),Object(c.b)("li",{parentName:"ul"},"Creates a read-only replica."),Object(c.b)("li",{parentName:"ul"},"Sets an access control rule based on that replica.")),Object(c.b)("p",null,"In addition, each ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin")," CA:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Creates a writable ",Object(c.b)("em",{parentName:"li"},"SharedMap")," to maintain the set of principals allowed to access the method ",Object(c.b)("code",{parentName:"li",className:"language-text"},"getCounter()"),"."),Object(c.b)("li",{parentName:"ul"},"Provides a ",Object(c.b)("code",{parentName:"li",className:"language-text"},"changePolicy()")," method to update this ",Object(c.b)("em",{parentName:"li"},"SharedMap"),". Only the owner of the ",Object(c.b)("code",{parentName:"li",className:"language-text"},"admin")," CA can invoke this method.")),Object(c.b)("p",null,"Principals can be a CA name, like ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo-ca1"),", but also the name of a CA owner, such as ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo"),". For the latter case, all the CAs owned by ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo")," will be allowed."),Object(c.b)("h5",null,"Delegation"),Object(c.b)("p",null,"Maintaining the quickly changing membership of a large group is a team effort."),Object(c.b)("p",null,"With ",Object(c.b)("em",{parentName:"p"},"Caf.js"),", it is very easy to get help from others by linking ",Object(c.b)("em",{parentName:"p"},"SharedMaps"),"."),Object(c.b)("p",null,"The security library will traverse the resulting graph, and a principal is in the allowed set if it is in ",Object(c.b)("strong",{parentName:"p"},"any")," of the reachable ",Object(c.b)("em",{parentName:"p"},"SharedMaps"),". The graph can have cycles too."),Object(c.b)("p",null,"And what's cool is that a ",Object(c.b)("em",{parentName:"p"},"SharedMap")," is a scalable distributed data structure, updated with transactional plugins, with clean semantics that do not break the Actor model. Supporting thousands of processes across many servers..."),Object(c.b)("p",null,"This means that access control policy will scale with your app. And policy changes should be predictable, and propagate quickly."),Object(c.b)("p",null,"Let's show how linking works:"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"LINK_KEY")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'__link_key__'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    \\\\ after ",Object(c.b)("span",{parentName:"code",className:"token function"},"changePolicy"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"linkNamespace"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"ns",Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," isAllowed"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"isAdmin"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," all ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Set"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"$$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"acl",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"get"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token constant"},"LINK_KEY"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"||")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            isAllowed ",Object(c.b)("span",{parentName:"code",className:"token operator"},"?")," all",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"add"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"ns",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," all",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"delete"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"ns",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"acl",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"set"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token constant"},"LINK_KEY"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token operator"},"..."),"all",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"else")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Error"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Not an admin'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    \\\\ before ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")))),Object(c.b)("p",null,"The default key for linking is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__link_key__"),". Its value is an array with the names of other ",Object(c.b)("code",{parentName:"p",className:"language-text"},"SharedMaps"),", for example, ",Object(c.b)("code",{parentName:"p",className:"language-text"},'["antonio-admin-friends", "joe-admin-acl"]'),". Only the owner of the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin")," CA can change it, using the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"linkNamespace()")," method."),Object(c.b)("h4",null,"Learn More"),Object(c.b)("p",null,"Decentralized authorization systems, such as SDSI, inspired our approach to access control policy. More details  ",Object(c.b)(N,{to:"../../apis/#caf_security",mdxType:"Link"},"here"),".")),Object(c.b)(l,{id:"sharedmap",mdxType:"DocsSection"},Object(c.b)("h2",null,"SharedMap"),Object(c.b)("p",null,"The Actor Model has a weakness. It is difficult to replicate state efficiently, and without breaking serialization, across many actors."),Object(c.b)("p",null,"When thousands of actors live in a process, it makes sense to use shared memory for replicated data. But if we do, we could introduce all the gremlins of shared memory programming. Deadlocks. Data races. Awful failure modes."),Object(c.b)("p",null,"A ",Object(c.b)("em",{parentName:"p"},"SharedMap")," takes advantage of shared-memory, keeps serialization, and avoids the gremlins. We discussed how ",Object(c.b)(N,{to:"../../apis/#caf_sharing",mdxType:"Link"},"here"),"."),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"SharedMaps")," are Distributed Data Structures (DDS) that can scale to thousands of processes on many nodes."),Object(c.b)("p",null,"A ",Object(c.b)("em",{parentName:"p"},"SharedMap")," has one writer, its CA owner, and many CAs that can read from it. Its name is relative to the CA owner. For example, if the CA name is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo-ca1"),", a valid ",Object(c.b)("em",{parentName:"p"},"SharedMap")," name is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo-ca1-map1"),". Naming, and the ",Object(c.b)(N,{to:"#trusted-bus",mdxType:"Link"},"Trusted Bus"),", ensure that the owner is the only writer."),Object(c.b)("p",null,"CAs treat a ",Object(c.b)("em",{parentName:"p"},"SharedMap")," as internal state. Updates are checkpointed with a transactional plugin, guaranteeing  ",Object(c.b)(N,{to:"#cloud-assistant",mdxType:"Link"},"external consistency"),". Updates respect serialization, and readers only see changes ",Object(c.b)("strong",{parentName:"p"},"after")," a completed request."),Object(c.b)("p",null,"Let's see some examples"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CA")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'admin'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_MAP")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'primarySharedMap'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"isAdmin")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"self"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," name ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," self",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_getName__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"splitName"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"name",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"===")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CA"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"primaryMap")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"self"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," name ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," self",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_getName__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"joinName"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"splitName"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"name",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CA"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_MAP"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"isAdmin"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," initialValue ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"counter",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"addWritableMap"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'primary'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_MAP"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"initialValue",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"addReadOnlyMap"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'replica'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"primaryMap"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_pulse__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"isAdmin"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"primary",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"get"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"primary",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"set"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," value ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"replica",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"get"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," value",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"Each user of this application first creates an ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin")," CA, and then multiple reader CAs. The ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin")," CA periodically updates a ",Object(c.b)("em",{parentName:"p"},"SharedMap"),", and readers provide a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"getCounter()")," method that will ",Object(c.b)("strong",{parentName:"p"},"eventually")," reflect these changes (see ",Object(c.b)(N,{to:"../../apis/#caf_sharing",mdxType:"Link"},"monotonic read consistency"),")."),Object(c.b)("p",null,"CA creation order is important because readers will block until the ",Object(c.b)("em",{parentName:"p"},"SharedMap")," is available. To avoid blocking, we can set the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"{bestEffort: true}")," option in the method ",Object(c.b)("code",{parentName:"p",className:"language-text"},"addReadOnlyMap()"),". In that case, when the map is not available, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"$$.replica")," would be ",Object(c.b)("code",{parentName:"p",className:"language-text"},"null"),", and CAs can call ",Object(c.b)("code",{parentName:"p",className:"language-text"},"addReadOnlyMap()")," again. This retry is typically added to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_pulse__()"),"."),Object(c.b)("p",null,"Note that, after ",Object(c.b)("em",{parentName:"p"},"SharedMap")," creation, a reader CA does not depend on the writer CA to be active. It always loads the last snapshot of the ",Object(c.b)("em",{parentName:"p"},"SharedMap"),"."),Object(c.b)("p",null,"In the previous example, we used the aliases ",Object(c.b)("code",{parentName:"p",className:"language-text"},"primary")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"replica"),", and access the  ",Object(c.b)("em",{parentName:"p"},"SharedMaps")," with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"$$.primary")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"$$.replica"),". These are just local aliases, changing them has no external effects."),Object(c.b)("p",null,"Initialization of a ",Object(c.b)("em",{parentName:"p"},"SharedMap")," uses the option ",Object(c.b)("code",{parentName:"p",className:"language-text"},"initialValue"),". This is convenient because we cannot write to it in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_init__()"),"."),Object(c.b)("p",null,"Updates respect serialization. If we rewrite ",Object(c.b)("code",{parentName:"p",className:"language-text"},"getCounter()")," like this"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},"    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," counter1 ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"replica",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"get"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"await")," ",Object(c.b)("span",{parentName:"span",className:"token function"},"setTimeoutPromise"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token number"},"10000"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," counter2 ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," $$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"replica",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"get"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token function"},"assert"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),"counter1 ",Object(c.b)("span",{parentName:"span",className:"token operator"},"===")," counter2",Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token string"},"'This never throws!'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),"counter1",Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," counter2",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")))),Object(c.b)("p",null,"the assertion ",Object(c.b)("strong",{parentName:"p"},"never")," throws. The values of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"counter1")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"counter2")," are always the same!"),Object(c.b)("p",null,"And a transactional plugin makes updates atomic, and externally consistent. For example, changing ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_pulse__")," to"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},"    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_pulse__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"isAdmin"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"primary",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"get"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            $$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"primary",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"set"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"1"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"await")," ",Object(c.b)("span",{parentName:"span",className:"token function"},"setTimeoutPromise"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token number"},"1000"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            $$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"primary",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"set"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'counter2'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"2"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"session",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"notify"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),"counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"1"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},","),"  counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"2"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")),"        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")))),Object(c.b)("p",null,"the value of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"counter2")," will ",Object(c.b)("strong",{parentName:"p"},"always")," be seen by readers as one more than the value of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"counter"),". And if a client receives the notification, it means that there is a checkpoint of a ",Object(c.b)("em",{parentName:"p"},"SharedMap")," capturing the new update. Note that this does not mean that replicas received the update, but they will eventually get it..."),Object(c.b)("p",null,"Another important advantage of ",Object(c.b)("em",{parentName:"p"},"SharedMaps")," is ",Object(c.b)("strong",{parentName:"p"},"silent updates"),". When the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"counter")," increments, readers do ",Object(c.b)("strong",{parentName:"p"},"not")," process a request to update their state, and instead, the update just changes shared memory. One memory update shared by thousands of CAs in the same process. That's so much faster than separate requests!"),Object(c.b)("h4",null,"Updating Code"),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"SharedMaps")," can contain serialized methods, set with the method ",Object(c.b)("code",{parentName:"p",className:"language-text"},"setFun()"),", and that transforms a ",Object(c.b)("em",{parentName:"p"},"SharedMap")," into a custom replicated object."),Object(c.b)("p",null,"There are serious security implications of using ",Object(c.b)("code",{parentName:"p",className:"language-text"},"eval")," to instantiate these methods, and ",Object(c.b)("em",{parentName:"p"},"Caf.js")," delays instantiation until the first call to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"applyMethod()"),". Moreover, the option ",Object(c.b)("code",{parentName:"p",className:"language-text"},"{noExec: true}")," for ",Object(c.b)("code",{parentName:"p",className:"language-text"},"addReadOnlyMap()")," disables instantiation forever."),Object(c.b)("p",null,"Never execute untrusted code. ",Object(c.b)("em",{parentName:"p"},"Caf.js")," is ",Object(c.b)("strong",{parentName:"p"},"not")," designed to protect your app from it. But the enforcement of the single-writer policy, together with the naming convention, authenticates the origin of a ",Object(c.b)("em",{parentName:"p"},"SharedMap")," custom method."),Object(c.b)("p",null,"A ",Object(c.b)("em",{parentName:"p"},"SharedMap")," can be replicated in an IoT device, or in the browser. This makes serialized methods a convenient way to quickly update code everywhere. For example, end users can safely upload their own code to your app in the Cloud, and then execute it only in their own Raspberry Pi, without compromising multi-tenancy in your application. See ",Object(c.b)("a",{parentName:"p",href:"https://github.com/cafjs/caf_hellodynamic.git"},"HelloDynamic")," for an example of programmable gesture detection."),Object(c.b)("p",null,"Transactional updates guarantee that changes to both data and code are always in sync. For example, you can create getters and setters that understand the internal schema of your ",Object(c.b)("em",{parentName:"p"},"SharedMap"),", and, whenever the schema changes, your helper methods will change too, matching the new schema. Never worry about data versioning again!"),Object(c.b)("p",null,"Let's show an example:"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token comment"},"// isAdmin() and primaryMap() similar to previous example"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"isAdmin"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"addWritableMap"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'primary'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_MAP"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"addReadOnlyMap"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'replica'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"primaryMap"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"install"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"base"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"isAdmin"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"primary",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"set"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'base'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," base",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," body ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"\"return prefix + (this.get('base') + Math.random());\""),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"primary",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"setFun"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'computeLabel'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token string"},"'prefix'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," body",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"else")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Error"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Cannot write to SharedMap'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getLabel"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"prefix"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"try")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," $$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"replica",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"applyMethod"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'computeLabel'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),"prefix",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"catch")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"In this example, calling ",Object(c.b)("code",{parentName:"p",className:"language-text"},"install")," by the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin")," owner initializes a  ",Object(c.b)("em",{parentName:"p"},"SharedMap")," with a field ",Object(c.b)("code",{parentName:"p",className:"language-text"},"base"),", and a method ",Object(c.b)("code",{parentName:"p",className:"language-text"},"computeLabel"),". This method takes an argument ",Object(c.b)("code",{parentName:"p",className:"language-text"},"prefix"),", looks up the key ",Object(c.b)("code",{parentName:"p",className:"language-text"},"base")," in the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"SharedMap"),", obtains a random number, and adds them all up."),Object(c.b)("p",null,"The first time we call ",Object(c.b)("code",{parentName:"p",className:"language-text"},"getLabel()"),", ",Object(c.b)("em",{parentName:"p"},"Caf.js")," calls ",Object(c.b)("code",{parentName:"p",className:"language-text"},"eval")," with the serialized method ",Object(c.b)("code",{parentName:"p",className:"language-text"},"computeLabel"),", and binds it to the ",Object(c.b)("em",{parentName:"p"},"SharedMap")," replica. Later invocations are much faster, since we only need to call ",Object(c.b)("code",{parentName:"p",className:"language-text"},"eval")," when the method changes.")),Object(c.b)(l,{id:"publish-subscribe",mdxType:"DocsSection"},Object(c.b)("h2",null,"Publish-Subscribe"),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Caf.js")," supports a traditional publish-subscribe communication pattern. There are two kinds of topics:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Private")," topics where only one CA can publish, but anybody can subscribe to receive them. The name of the topic is prefixed by the CA name. For example, if the owner CA name is ",Object(c.b)("code",{parentName:"li",className:"language-text"},"foo-ca1"),", a valid private topic is ",Object(c.b)("code",{parentName:"li",className:"language-text"},"foo-ca1-mynews"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("strong",{parentName:"li"},"Forum")," topics where anybody can publish or subscribe to. They always have the prefix ",Object(c.b)("code",{parentName:"li",className:"language-text"},"forum-"),", for example, ",Object(c.b)("code",{parentName:"li",className:"language-text"},"forum-othernews"),".")),Object(c.b)("p",null,"Subscribers dedicate a method for handling messages. It is recommended that this method is  internal, i.e., prefixed by ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_"),", and therefore, it is always invoked by the ",Object(c.b)("em",{parentName:"p"},"Trusted Bus"),"."),Object(c.b)("p",null,"The signature for this method is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"async function(topic, msg, from)"),",  with fields:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"topic: string")," needed to multiplex a method for several topics."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"msg: string")," received message, typically JSON-serialized."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"from: string")," authenticated publisher name. Needed because the method ",Object(c.b)("code",{parentName:"li",className:"language-text"},"this.$.security.getCallerFrom()")," does not provide the real caller for internal methods.")),Object(c.b)("p",null,"Filtering of publishers is based on setting ",Object(c.b)("em",{parentName:"p"},"Trusted Bus")," policies for this method, or using the authenticated ",Object(c.b)("code",{parentName:"p",className:"language-text"},"from")," argument to change behavior."),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Publish-subscribe")," and ",Object(c.b)("em",{parentName:"p"},"SharedMap")," are typically used together. Publish is best effort, and  ",Object(c.b)("em",{parentName:"p"},"SharedMaps")," can be used to acknowledge important messages. Or a ",Object(c.b)("em",{parentName:"p"},"SharedMap")," can update the state of many CAs first, including code, and a later published message trigger actions using the new state."),Object(c.b)("p",null,"Point-to-point messaging can be emulated with private topics. Point-to-point is ",Object(c.b)("strong",{parentName:"p"},"the root of all evil")," regarding scalability. At the network level, it always creates an all-to-all communication pattern in actor systems. Try to abstract communication with higher level services, such as ",Object(c.b)("em",{parentName:"p"},"Publish-subscribe")," or ",Object(c.b)("em",{parentName:"p"},"SharedMap"),", and limit point-to-point to where it is strictly necessary."),Object(c.b)("p",null,"Let's show an example:"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CA")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'admin'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CHANNEL")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'myNews'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"isAdmin")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"self"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," name ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," self",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_getName__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"splitName"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"name",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"===")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CA"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token function-variable function"},"primaryChannel")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"function"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"self"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," name ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," self",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_getName__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"joinName"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"splitName"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"name",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CA"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"ADMIN_CHANNEL"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"pubsub",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"subscribe"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"primaryChannel"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'__ca_handleMessage__'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_pulse__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"isAdmin"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"pubsub",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"publish"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token function"},"primaryChannel"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n                                  ",Object(c.b)("span",{parentName:"code",className:"token template-string"},Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`"),Object(c.b)("span",{parentName:"span",className:"token string"},"Counter: "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_handleMessage__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"topic",Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," msg",Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"from")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token template-string"},Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`"),Object(c.b)("span",{parentName:"span",className:"token string"},"Got "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"msg",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token string"}," from "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),Object(c.b)("span",{parentName:"span",className:"token keyword"},"from"),Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"session",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"notify"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),"msg",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"The ",Object(c.b)("code",{parentName:"p",className:"language-text"},"admin")," CA periodically publishes a counter, which any other CA with the same owner subscribes to. The response to a received message is to queue a client notification."),Object(c.b)("p",null,"Note that the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"pubsub")," plugin is transactional, and respects external consistency. This means that when ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_pulse__")," publishes a new counter, the checkpointed  state of this CA already reflects the new counter.")),Object(c.b)(l,{id:"iot-device",mdxType:"DocsSection"},Object(c.b)("h2",null,"IoT Device"),Object(c.b)("p",null,"In this section we cover the code that you write under the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"./iot")," directory. Bridging code that runs in the browser, or in a Raspberry Pi, or in an ARM container during development. See ",Object(c.b)(N,{to:"#add-device",mdxType:"Link"},"Simulated Device")," for an introduction."),Object(c.b)("h4",null,"Caf.js Lite"),Object(c.b)("p",null,"The platform running your IoT device code is a simplified version of the one that runs CAs. We call it ",Object(c.b)("em",{parentName:"p"},"Caf.js Lite"),"."),Object(c.b)("p",null,"There is at most ",Object(c.b)("strong",{parentName:"p"},"one")," ",Object(c.b)("em",{parentName:"p"},"CA Lite")," instance per ",Object(c.b)("em",{parentName:"p"},"Caf.js Lite")," platform. The long term state of this instance is managed by a ",Object(c.b)("em",{parentName:"p"},"Companion CA")," in the Cloud."),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Caf.js Lite")," does not checkpoint. When a device restarts, it first resets the ",Object(c.b)("em",{parentName:"p"},"CA Lite")," state, and then, it contacts its ",Object(c.b)("em",{parentName:"p"},"Companion CA")," for instructions and data."),Object(c.b)("p",null,"Without local long term state, consistency is less of a concern. And some plugins are not transactional, interacting directly with the device to improve latency."),Object(c.b)("p",null,"We kept some ",Object(c.b)("em",{parentName:"p"},"CA")," features. Method execution serialized by a queue. An error rollbacks the changes to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.state"),". Hierarchies of components configured with JSON descriptions. Plugins accessed with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$"),". Support for ",Object(c.b)("em",{parentName:"p"},"SharedMaps"),"..."),Object(c.b)("p",null,"In ",Object(c.b)("em",{parentName:"p"},"Caf.js Lite"),", configuration is simpler. There is only one JSON file, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot.json"),", which merges the functionality of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"framework.json")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca.json"),"."),Object(c.b)("p",null,"We also made explicit that ",Object(c.b)("em",{parentName:"p"},"Caf.js Lite")," is not ",Object(c.b)("em",{parentName:"p"},"Caf.js")," by renaming some methods. For example, paying homage to ",Object(c.b)("em",{parentName:"p"},"Arduino"),", ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_init__")," becomes ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__iot_setup__"),", and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_pulse__")," is now ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__iot_loop__"),"."),Object(c.b)("p",null,"Complete examples are in ",Object(c.b)("a",{parentName:"p",href:"https://github.com/cafjs/caf_iot.git"},"GitHub"),"."),Object(c.b)("p",null,'Let\'s look at a "Hello World" example first.'),Object(c.b)("p",null,"The ",Object(c.b)("em",{parentName:"p"},"CA Lite")," code in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot/lib/iot_methods.js")),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf_iot ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_iot'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_setup__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"toCloud",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"get"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token operator"},"||")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"0"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_loop__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," msg ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"fromCloud",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"get"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'msg'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token operator"},"||")," ",Object(c.b)("span",{parentName:"span",className:"token string"},"'Counter:'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"toCloud",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"set"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf_iot",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"and the ",Object(c.b)("em",{parentName:"p"},"Companion CA")," implementation in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"lib/ca_methods.js"),":"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"setMessage"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"newMsg"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        $$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"fromCloud",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"set"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'msg'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," newMsg",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," $$ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"sharing",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," $$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"toCloud",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"get"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"What are ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.toCloud")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.fromCloud"),"? Two ",Object(c.b)(N,{to:"#sharedmap",mdxType:"Link"},"SharedMaps")," that every ",Object(c.b)("em",{parentName:"p"},"CA Lite")," has. They are both managed in the Cloud by the ",Object(c.b)("em",{parentName:"p"},"Companion CA"),", but by convention:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"this.toCloud")," can only be written by the ",Object(c.b)("em",{parentName:"li"},"CA Lite"),", and read by both the ",Object(c.b)("em",{parentName:"li"},"CA Lite")," and its ",Object(c.b)("em",{parentName:"li"},"Companion CA"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"this.fromCloud")," written by the ",Object(c.b)("em",{parentName:"li"},"Companion CA"),", and read by the ",Object(c.b)("em",{parentName:"li"},"CA Lite"),".")),Object(c.b)("p",null,"How does it work? After processing a request, the ",Object(c.b)("em",{parentName:"p"},"CA Lite")," syncs its state with the ",Object(c.b)("em",{parentName:"p"},"Companion CA"),". Local changes to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.toCloud")," are uploaded, and then applied to its primary ",Object(c.b)("em",{parentName:"p"},"SharedMap")," in the Cloud. The local replica of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.fromCloud")," gets updated too."),Object(c.b)("p",null,"By having both primaries in the Cloud, they are always checkpointed, and managed with transactions. And sensor data from one device can be easily shared by creating more replicas of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.toCloud"),"."),Object(c.b)("p",null,"Syncing every request with the Cloud is sometimes too costly. Skip the sync with the option ",Object(c.b)("code",{parentName:"p",className:"language-text"},"{noSync: true}")," for ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cron")," tasks, or for requests explicitly created with the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.queue")," plugin."),Object(c.b)("p",null,"Going back to the example. During initialization, the last ",Object(c.b)("code",{parentName:"p",className:"language-text"},"counter")," value is read from ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.toCloud"),". Authorized clients can also get it with the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"getCounter()")," method, which reads from the same ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.toCloud"),"."),Object(c.b)("p",null,"In the other direction, the value of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"msg")," is set by the ",Object(c.b)("em",{parentName:"p"},"Companion CA")," in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"setMessage()"),", which writes to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.fromCloud"),". After sync, the device changes the log message in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__iot_loop__"),", also using ",Object(c.b)("code",{parentName:"p",className:"language-text"},"msg"),"."),Object(c.b)("h4",null,Object(c.b)("em",{parentName:"h4"},"Companion CA")," Hooks"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token comment"},"// methods called by the iot device"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"trace__iot_sync__ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'__ca_traceSync__'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"trace__iot_resume__ ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'__ca_traceResume__'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token comment"},"// called when the device syncs state"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_traceSync__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," now ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Date"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getTime"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Syncing!!:'")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," now",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token comment"},"// called when the device reconnects"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_traceResume__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," now ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Date"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getTime"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Resuming!!:'")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," now",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"The ",Object(c.b)("em",{parentName:"p"},"Companion CA")," can schedule an action when the ",Object(c.b)("em",{parentName:"p"},"CA Lite")," connects, or syncs state  with it. Just define two hook methods, typically called ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_traceSync__")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__ca_traceResume__"),"."),Object(c.b)("h4",null,"Cron Tasks"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf_iot ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_iot'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," util ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'util'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," setTimeoutPromise ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," util",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"promisify"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"setTimeout",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_setup__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," options ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"noSync",Object(c.b)("span",{parentName:"code",className:"token operator"},":")," ",Object(c.b)("span",{parentName:"code",className:"token boolean"},"true"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"toCloud",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"get"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"||")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"cron",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"addCron"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'helloCron'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token string"},"'greetings'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token string"},"'Hello:'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"2000"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," options",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"cron",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"addCron"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'byeCron'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token string"},"'greetings'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token string"},"'Bye:'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"3000"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," options",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_loop__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"fromCloud",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"get"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'msg'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"||")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'Counter:'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"toCloud",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"set"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"span",className:"token function"},"greetings"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token parameter"},"greet"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"{")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," now ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"span",className:"token class-name"},"Date"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"getTime"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"span",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"debug"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),"greet ",Object(c.b)("span",{parentName:"span",className:"token operator"},"+")," now",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"}")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf_iot",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"It is easy to create periodic tasks with the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cron")," plugin. This example creates two sequences of log entries, using two different prefixes. The first argument to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"addCron()")," is the name of the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cron"),", needed to delete it. In this case, only ",Object(c.b)("code",{parentName:"p",className:"language-text"},"__iot_loop__()")," syncs with the Cloud."),Object(c.b)("p",null,"Note that JavaScript is a garbage-collected language, and it cannot provide hard real-time guarantees. However, in a lightly loaded Raspberry Pi 4, it is reasonable to expect ",Object(c.b)("strong",{parentName:"p"},"most of the time")," interval time variation within 10 msec, for an interval longer than 100 msec."),Object(c.b)("p",null,"If you need better, you could use the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cron")," task to configure a microcontroller, well in advance of triggering the action."),Object(c.b)("h4",null,"Error Handling"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf_iot ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_iot'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," myUtils ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," caf_iot",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"caf_components",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"myUtils",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," util ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'util'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," setTimeoutPromise ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," util",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"promisify"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"setTimeout",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_setup__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"toCloud",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"get"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"||")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"cron",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"addCron"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'crashCron'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token string"},"'crash'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"5000"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_loop__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"fromCloud",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"get"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'msg'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"||")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'Counter:'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"toCloud",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"set"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'counter'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"span",className:"token function"},"crash"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"{")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"await")," ",Object(c.b)("span",{parentName:"span",className:"token function"},"setTimeoutPromise"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token number"},"100"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"throw")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"span",className:"token class-name"},"Error"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'Oops'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token comment"},"// delete this method and see how error handling changes")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"span",className:"token function"},"__iot_error__"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token parameter"},"error"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"{")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"span",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"warn"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'Got error '")," ",Object(c.b)("span",{parentName:"span",className:"token operator"},"+")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"                                      myUtils",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"errToPrettyStr"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),"error",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token comment"},"// try `return [error]` and see what happens")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"    ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"}")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf_iot",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"The default error handling strategy in ",Object(c.b)("em",{parentName:"p"},"Caf.js Lite")," is to log the error, and then do a full reset."),Object(c.b)("p",null,"We can change this behavior by adding ",Object(c.b)("code",{parentName:"p",className:"language-text"}," __iot_error__()"),", an error handler method."),Object(c.b)("p",null,"If ",Object(c.b)("code",{parentName:"p",className:"language-text"}," __iot_error__()")," propagates the error in the returned array tuple, ",Object(c.b)("em",{parentName:"p"},"Caf.js Lite")," does a full reset, as before. But, when the error is not returned, it is ignored by the runtime, giving you full control."),Object(c.b)("h4",null,"Cloud Client"),Object(c.b)("p",null,"A device plugin called ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cloud")," wraps the standard ",Object(c.b)(N,{to:"#client",mdxType:"Link"},"Client Library"),"."),Object(c.b)("p",null,"A ",Object(c.b)("em",{parentName:"p"},"CA Lite")," can call external methods of the ",Object(c.b)("em",{parentName:"p"},"Companion CA")," using this plugin."),Object(c.b)("p",null,"It can also receive notifications, using the default session name ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot"),", which can be changed in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot++.json"),"."),Object(c.b)("p",null,"The default behavior for handling a notification is to sync state. However, using the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"registerHandler()")," method, we can add our own handler. This handler typically creates, using the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"queue")," plugin, a local request to process the notification."),Object(c.b)("p",null,"Let's look at an example:"),Object(c.b)("p",null,"The ",Object(c.b)("em",{parentName:"p"},"CA Lite")," code in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot/lib/iot_methods.js")),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf_iot ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_iot'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_setup__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"cloud",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"registerHandler"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token parameter"},"msg"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=>")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"{")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," args ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"cloud",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"getMethodArgs"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),"msg",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"queue",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"process"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token string"},"'greetings'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," args",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"greetings"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"msg"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," now ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Date"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getTime"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," now",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"try")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"            ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," value ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"await")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"cloud",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"cli",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"getPromise"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Got '")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," value",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"catch")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),"err",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_loop__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," now ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Date"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getTime"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'loop:'")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," now",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf_iot",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"and the ",Object(c.b)("em",{parentName:"p"},"Companion CA")," implementation in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"lib/ca_methods.js"),":"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'foo:'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_pulse__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"session",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"notify"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"msg",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token string"},"'iot'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"setMessage"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"newMsg"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," newMsg",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"The ",Object(c.b)("em",{parentName:"p"},"Companion CA")," periodically creates a notification with session name ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot"),".\nThis notification is handled by the ",Object(c.b)("em",{parentName:"p"},"CA Lite")," by calling ",Object(c.b)("code",{parentName:"p",className:"language-text"},"greetings()"),". This method then calls back the ",Object(c.b)("em",{parentName:"p"},"Companion CA")," to read the current counter."),Object(c.b)("h4",null,"Timed Bundles"),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Warning: do not use ",Object(c.b)("strong",{parentName:"em"},"Caf.js")," for safety critical applications.")),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Caf.js IoT Device"),"  was originally created to control ",Object(c.b)("strong",{parentName:"p"},"drones")," using the Cloud. It was fun, and we learnt a few things in the hard way:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Losing connectivity, or an increase in latency, meant that a crash was likely."),Object(c.b)("li",{parentName:"ul"},"Accurate coordination of more than a few drones was difficult.")),Object(c.b)("p",null,"To improve reliability and scalability we did four changes:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Modify the drone firmware to run ",Object(c.b)("em",{parentName:"li"},"Caf.js Lite")," locally."),Object(c.b)("li",{parentName:"ul"},"Group actions, with relative timing between them, into ",Object(c.b)("strong",{parentName:"li"},"bundles"),"."),Object(c.b)("li",{parentName:"ul"},"Start executing a bundle with Coordinated Universal Time (UTC), not just when it arrives. Keep the drone clock synchronized with the Cloud."),Object(c.b)("li",{parentName:"ul"},"Execute actions from ",Object(c.b)("strong",{parentName:"li"},"at most one")," bundle at ",Object(c.b)("strong",{parentName:"li"},"any time"),".")),Object(c.b)("p",null,"By bundling actions, once the first action started, the others will follow, regardless of connectivity."),Object(c.b)("p",null,"Therefore, a bundle could always leave the drone in a safe state by adding late recovery actions. When the next bundle executes on time, the previous recovery actions are ignored. But, when it does not, the custom recovery actions will take over."),Object(c.b)("p",null,"And firing bundles with UTC time meant that the ",Object(c.b)("em",{parentName:"p"},"Companion CA")," could pipeline them, caching them in the drone before they were needed, providing smooth movement. But, at the same time, a new bundle could quickly change drone direction, invalidating the previously cached bundle."),Object(c.b)("p",null,"Moreover, using UTC time meant that we could now coordinate drone actions across the world, and scale to millions. We just needed millions of ",Object(c.b)("em",{parentName:"p"},"Companion CAs"),", using ",Object(c.b)("em",{parentName:"p"},"SharedMaps")," to share state, and ",Object(c.b)("em",{parentName:"p"},"Publish-Subscribe")," to coordinate,  and a second or two of early warning to customize and propagate the bundles."),Object(c.b)("p",null,"You can read all about our world domination ambitions ",Object(c.b)(N,{to:"../../collaborative",mdxType:"Link"},"here"),". The drones are coming."),Object(c.b)("p",null,"In a more serious note, let's show how to code world domination."),Object(c.b)("p",null,"The ",Object(c.b)("em",{parentName:"p"},"CA Lite")," code in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot/lib/iot_methods.js")),Object(c.b)("div",{className:"gatsby-highlight","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf_iot ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_iot'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_setup__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"down"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"speed"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," now ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Date"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getTime"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token template-string"},Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`"),Object(c.b)("span",{parentName:"span",className:"token string"},"vvvvvvvvDown: "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"now",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token string"}," speed: "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"speed",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"up"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"speed"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," now ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Date"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getTime"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token template-string"},Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`"),Object(c.b)("span",{parentName:"span",className:"token string"},"^^^^^^^^Up: "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"now",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token string"}," speed: "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"speed",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"recover"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"msg"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," now ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Date"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getTime"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token template-string"},Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`"),Object(c.b)("span",{parentName:"span",className:"token string"},"RECOVERING: "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"now",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token string"}," msg: "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"msg",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__iot_loop__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," now ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token keyword"},"new")," ",Object(c.b)("span",{parentName:"code",className:"token class-name"},"Date"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getTime"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token template-string"},Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`"),Object(c.b)("span",{parentName:"span",className:"token string"},"loop: "),Object(c.b)("span",{parentName:"span",className:"token interpolation"},Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"${"),"now",Object(c.b)("span",{parentName:"span",className:"token interpolation-punctuation punctuation"},"}")),Object(c.b)("span",{parentName:"span",className:"token template-punctuation string"},"`")),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf_iot",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"and the ",Object(c.b)("em",{parentName:"p"},"Companion CA")," implementation in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"lib/ca_methods.js"),":"),Object(c.b)("div",{className:"gatsby-highlight has-highlighted-lines","data-language":"js"},Object(c.b)("pre",{parentName:"div",className:"language-js"},Object(c.b)("code",{parentName:"pre",className:"language-js"},Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," caf ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"require"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'caf_core'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"token comment"},"// TRY: reduce the margin to <10msec and see how bundles arrive late"),"\n",Object(c.b)("span",{parentName:"code",className:"token keyword"},"const")," ",Object(c.b)("span",{parentName:"code",className:"token constant"},"MARGIN")," ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"100"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\nexports",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"methods ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_init__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"0"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token string"},"'foo:'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"maxAcks ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"1"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"__ca_pulse__"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"if")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"acks ",Object(c.b)("span",{parentName:"span",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"acks",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"length ",Object(c.b)("span",{parentName:"span",className:"token operator"},">")," ",Object(c.b)("span",{parentName:"span",className:"token number"},"0"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token operator"},"&&")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"             ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token operator"},"!"),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"acks",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token number"},"0"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"result",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"{")),"            ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"log",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"debug"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token string"},"'Last bundle was late'"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"1"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n",Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"const")," bundle ",Object(c.b)("span",{parentName:"span",className:"token operator"},"=")," ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"iot",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"newBundle"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token constant"},"MARGIN"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token comment"},"// TRY: kill the server, and the device eventually executes `recover`")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        bundle",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"down"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token number"},"0"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token number"},"1"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"up"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token number"},"300"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token number"},"1"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"recover"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token number"},"5000"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token string"},"'go home'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"iot",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"sendBundle"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),"bundle",Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token comment"},"// `notify` improves responsiveness.")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token comment"},"//TRY: comment the following line, and see how bundles arrive late")),Object(c.b)("span",{parentName:"code",className:"gatsby-highlight-code-line"},"        ",Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"$",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"session",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"span",className:"token function"},"notify"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"span",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"span",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"span",className:"token string"},"'iot'"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"span",className:"token punctuation"},";")),"        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"setMessage"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token parameter"},"newMsg"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"=")," newMsg",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},","),"\n    ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"async")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"getCounter"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),Object(c.b)("span",{parentName:"code",className:"token punctuation"},")")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"{"),"\n        ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"return")," ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"["),Object(c.b)("span",{parentName:"code",className:"token keyword"},"null"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},",")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"msg ",Object(c.b)("span",{parentName:"code",className:"token operator"},"+")," ",Object(c.b)("span",{parentName:"code",className:"token keyword"},"this"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"state",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),"counter",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"]"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\n    ",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),"\n",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"}"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"\ncaf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},"."),Object(c.b)("span",{parentName:"code",className:"token function"},"init"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},"("),"module",Object(c.b)("span",{parentName:"code",className:"token punctuation"},")"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")))),Object(c.b)("p",null,"How to create a ",Object(c.b)("em",{parentName:"p"},"Timed Bundle"),"? The plugin ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot")," provides a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"newBundle")," method, with an argument to customize the expected propagation time for the bundle. Similar to the construction of a session with the ",Object(c.b)("em",{parentName:"p"},"Client Library"),", the plugin introspects the code in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot_methods.js"),", and adds methods for creating individual actions. Relative timing is always in milliseconds."),Object(c.b)("p",null,"The ",Object(c.b)("code",{parentName:"p",className:"language-text"},"sendBundle()")," method freezes the starting UTC time of the bundle, and makes it available to the ",Object(c.b)("em",{parentName:"p"},"CA Lite"),". It can also take a starting time offset, to be added to the propagation time."),Object(c.b)("p",null,"The ",Object(c.b)("em",{parentName:"p"},"CA Lite")," will get the bundle the next time it syncs. It is wise to force it to sync ",Object(c.b)("strong",{parentName:"p"},"asap"),", by sending a notification to the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot")," session. See the ",Object(c.b)("em",{parentName:"p"},"Cloud Client")," previous section for details."),Object(c.b)("p",null,"Late bundles are ignored. The ",Object(c.b)("em",{parentName:"p"},"Companion CA")," learns that the last bundle was late by setting ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.state.maxAcks")," to one, and periodically reading ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.state.acks[0].result"),". In robust applications, it will dynamically adjust the propagation margin when that happens."),Object(c.b)("p",null,"In some cases we want to execute a bundle when it arrives. For example, in an emergency situation. We can force this behavior by adding the argument ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.iot.NOW")," to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"sendBundle()"),"."),Object(c.b)("p",null,"The problem with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.iot.NOW")," is that a month-old bundle, could still trigger an action when we turn on the device. It is recommended to use instead ",Object(c.b)("code",{parentName:"p",className:"language-text"},"this.$.iot.NOW_SAFE"),", which expires the bundle after a reasonable time limit. The default is ten minutes."),Object(c.b)("h4",null,"Learn More"),Object(c.b)("p",null,"Connect to Bluetooth devices using the ",Object(c.b)(N,{to:"../../apis/#caf_iot_gatt",mdxType:"Link"},"gatt")," plugin. Switch GPIO pins with ",Object(c.b)(N,{to:"../../apis/#caf_rpi_gpio",mdxType:"Link"},"gpio"),". Explore ",Object(c.b)("em",{parentName:"p"},"Caf.js Lite")," APIs ",Object(c.b)(N,{to:"../../apis/#caf_iot",mdxType:"Link"},"here"),"."))),Object(c.b)(r,{id:"getting-started",mdxType:"DocsArticle"},Object(c.b)("h1",null,"Getting Started"),Object(c.b)(l,{id:"install",mdxType:"DocsSection"},Object(c.b)("h2",null,"Install"),Object(c.b)("h4",null,"Software Requirements"),Object(c.b)("p",null,Object(c.b)("code",{parentName:"p",className:"language-text"},"node")," >= 12 (LTS only), ",Object(c.b)("code",{parentName:"p",className:"language-text"},"yarn")," >= 1.20, and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"docker")," >= 19."),Object(c.b)("p",null,"We rely on ",Object(c.b)("code",{parentName:"p",className:"language-text"},"yarn")," workspaces, and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"npm")," does not support them yet."),Object(c.b)("p",null,"Our development is mostly on Linux. Best platform for running ",Object(c.b)("code",{parentName:"p",className:"language-text"},"docker")," containers."),Object(c.b)("h4",null,"Download"),Object(c.b)("p",null,"Clone the main repository"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token function"},"git")," clone https://github.com/cafjs/caf.git"))),Object(c.b)("p",null,"Update submodules"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," caf",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"git")," submodule update --init"))),Object(c.b)("p",null,"Install dependencies"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token function"},"yarn")," run installAll"))),Object(c.b)("p",null,"Add to your path the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cafjs")," tool binary"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"export")," ",Object(c.b)("span",{parentName:"code",className:"token assign-left variable"},Object(c.b)("span",{parentName:"span",className:"token environment constant"},"PATH")),Object(c.b)("span",{parentName:"code",className:"token operator"},"="),Object(c.b)("span",{parentName:"code",className:"token operator"},"<"),"your_install_directory",Object(c.b)("span",{parentName:"code",className:"token operator"},">"),"/caf/bin:",Object(c.b)("span",{parentName:"code",className:"token environment constant"},"$PATH")))),Object(c.b)("p",null,"Download the latest ",Object(c.b)("code",{parentName:"p",className:"language-text"},"docker")," images"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"cafjs update"))),Object(c.b)("h4",null,"Test"),Object(c.b)("p",null,"Let's build and run locally a simple app."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," apps/caf_helloworld",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs build",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs run helloworld"))),Object(c.b)("p",null,"With ",Object(c.b)("code",{parentName:"p",className:"language-text"},"docker ps")," you should see seven running containers. They simulate the support services that we run in the Cloud."),Object(c.b)("p",null,"The app launcher URL is ",Object(c.b)("a",{parentName:"p",href:"http://root-launcher.vcap.me"},"http://root-launcher.vcap.me")," (DNS resolves ",Object(c.b)("code",{parentName:"p",className:"language-text"},"*.vcap.me")," to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"127.0.0.1"),", the local loop). Using your browser, login with user ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo")," and password ",Object(c.b)("code",{parentName:"p",className:"language-text"},"bar"),". Then, with the top left menu, click the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"+")," icon to add a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"helloworld")," app instance."),Object(c.b)("p",null,"Fill the form with:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"App publisher: ",Object(c.b)("code",{parentName:"li",className:"language-text"},"root")," (in local mode apps are always published by ",Object(c.b)("code",{parentName:"li",className:"language-text"},"root"),")"),Object(c.b)("li",{parentName:"ul"},"App name: ",Object(c.b)("code",{parentName:"li",className:"language-text"},"helloworld")),Object(c.b)("li",{parentName:"ul"},"CA name: anything containing ASCII characters and numbers.")),Object(c.b)("p",null,"and a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"counter")," example should appear. Use the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"+")," again to create other instances, and then switch between them with the top left menu."),Object(c.b)("p",null,"To stop it, a single ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Control-C")," will initiate a gentle container shutdown but, for the impatient, a second ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Control-C")," will brute force a clean-up. Double tap."),Object(c.b)("p",null,"In both cases we should be able to restart without losing the previous state, since the Redis container generates a checkpoint file in the host diretory ",Object(c.b)("code",{parentName:"p",className:"language-text"},"/tmp"),". Delete this file to start from scratch:"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token function"},"sudo")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"rm")," /tmp/redis/appendonly.aof"))),Object(c.b)("p",null,"Finally, when containers hang, we can always use the nuclear cleanup option"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"cafjs reset")))),Object(c.b)(l,{id:"headless-example",mdxType:"DocsSection"},Object(c.b)("h2",null,"Your First App"),Object(c.b)("p",null,"Let's create a simple app with no front end."),Object(c.b)("p",null,Object(c.b)("em",{parentName:"p"},"Caf.js")," is managed as a monorepo using ",Object(c.b)("code",{parentName:"p",className:"language-text"},"yarn")," workspaces. Anything under the sub-directory ",Object(c.b)("code",{parentName:"p",className:"language-text"},"caf/playground/app")," becomes part of the workspace, and we will create the app there."),Object(c.b)("p",null,"Using a monorepo has many advantages, but the most important one is that you know what you are getting. When we create a release of ",Object(c.b)("em",{parentName:"p"},"Caf.js")," we freeze all our packages, and test them together. Your app will not suffer from semver mistakes due to these packages."),Object(c.b)("p",null,"To create the app skeleton we use ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cafjs generate"),", an application template generator. The default templates are in a Docker image, and it is easy to customize and share your templates by publishing a new image. See  ",Object(c.b)(N,{to:"#tools",mdxType:"Link"},"Tools")," for details."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," playground",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"rm")," -fr app",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"  cafjs generate myapp cloud ./app"))),Object(c.b)("p",null,"and then install, build, and run. Install is only needed for the first build, to update dependencies in the monorepo."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," app",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs ",Object(c.b)("span",{parentName:"code",className:"token function"},"install"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs build",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"  cafjs run -d myapp"))),Object(c.b)("p",null,"This time we used the flag ",Object(c.b)("code",{parentName:"p",className:"language-text"},"-d")," to turn on debugging mode. You should see debug logs in the console. It also opens the debug port ",Object(c.b)("code",{parentName:"p",className:"language-text"},"9229"),", and you can set breakpoints, and inspect variables, with the Chrome browser developer tools (",Object(c.b)("code",{parentName:"p",className:"language-text"},"chrome://inspect"),"). The ",Object(c.b)("em",{parentName:"p"},"Redis")," instance is also accessible in host port ",Object(c.b)("code",{parentName:"p",className:"language-text"},"6380"),"."),Object(c.b)("p",null,"There is no front end, and we use a script in the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"util")," directory to read state, and subscribe to notifications."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," util",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," ./client.js --url http://root-myapp.vcap.me bar foo-ca1"))),Object(c.b)("p",null,"What is in the box?"),Object(c.b)("p",null,"Let's look at the files in the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"lib")," directory:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"rsa_pub.pem")," A dummy public key to validate authentication tokens in a local deployment. When you deploy your app in the ",Object(c.b)("em",{parentName:"li"},"Caf.js Cloud"),', we swap this key by the "real" one.'),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"framework++.json")," Describes changes to the baseline platform configuration in ",Object(c.b)(N,{to:"../../apis/#caf_platform",mdxType:"Link"},"framework.json"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"ca++.json")," Describes changes to the baseline cloud assistant configuration in ",Object(c.b)(N,{to:"../../apis/#caf_ca",mdxType:"Link"},"ca.json"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"ca_methods.js")," Your code.")),Object(c.b)("p",null,"To understand the json files have a look at our ",Object(c.b)(N,{to:"#components",mdxType:"Link"},"component model"),". Sections ",Object(c.b)(N,{to:"#cloud-assistant",mdxType:"Link"},"Cloud Assistant")," and ",Object(c.b)(N,{to:"#autonomous",mdxType:"Link"},"Autonomous Computation")," cover ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca_methods.js"),". The script is explained in the ",Object(c.b)(N,{to:"#client",mdxType:"Link"},"Client Library"),".")),Object(c.b)(l,{id:"add-react-frontend",mdxType:"DocsSection"},Object(c.b)("h2",null,"Add a React User Interface"),Object(c.b)("p",null,"Let's add a ",Object(c.b)("em",{parentName:"p"},"React")," front end to the previous app."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," playground",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"rm")," -fr app",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"  cafjs generate myapp web ./app"))),Object(c.b)("p",null,"and again:"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," app",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs ",Object(c.b)("span",{parentName:"code",className:"token function"},"install"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs build",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"  cafjs run -d myapp"))),Object(c.b)("p",null,"and now, as we did for testing the ",Object(c.b)(N,{to:"#install",mdxType:"Link"},"installation"),", login with the browser, and create a few instances with app name ",Object(c.b)("code",{parentName:"p",className:"language-text"},"myapp"),", and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"root")," publisher, since we are in local mode."),Object(c.b)("p",null,"The app uses ",Object(c.b)(N,{to:"/autonomous",mdxType:"Link"},"Proactive Server Side Rendering (PSSR)")," for fast app switching. The json files add the required ",Object(c.b)(N,{to:"../../apis/#caf_react",mdxType:"Link"},"React plugin"),".  In ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca_methods.js")," there is also a new method ",Object(c.b)("code",{parentName:"p",className:"language-text"},"hello()"),", which provides the cache key for rendering, and a few calls to the new plugin. Without PSSR the cloud code would look similar to the previous example."),Object(c.b)("p",null,"The code in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"public")," is mostly a standard ",Object(c.b)("code",{parentName:"p",className:"language-text"},"React")," app, which uses ",Object(c.b)("code",{parentName:"p",className:"language-text"},"redux")," to manage state, and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"react-bootstrap")," components to build the UI."),Object(c.b)("p",null,"The only novelties are a session object to connect to a cloud assistant in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"AppSession.js"),", binding actions to remote methods in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"AppActions.js"),", and a custom initialization in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"app.js"),"."),Object(c.b)("p",null,"These are ",Object(c.b)("strong",{parentName:"p"},"not")," hard dependencies. This is just an example integrating ",Object(c.b)("em",{parentName:"p"},"Caf.js")," with a front end, using libraries that we are familiar with. There are no ",Object(c.b)("em",{parentName:"p"},"Caf.js")," dependencies with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"react-bootstrap"),". Replacing ",Object(c.b)("code",{parentName:"p",className:"language-text"},"redux")," by another state management solution just needs a simple integration with the client library, similar to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"AppActions.js"),". For PSSR, replacing ",Object(c.b)("code",{parentName:"p",className:"language-text"},"React")," by another framework would require a new plugin.")),Object(c.b)(l,{id:"cafjs-cloud",mdxType:"DocsSection"},Object(c.b)("h2",null,"Caf.js Cloud"),Object(c.b)("p",null,"If you are self-hosting your apps, you can skip this section."),Object(c.b)("p",null,"The ",Object(c.b)("em",{parentName:"p"},"Caf.js Cloud")," is currently in beta, and this section is likely to change."),Object(c.b)("h4",null,"Requirements"),Object(c.b)("p",null,"Create a ",Object(c.b)("em",{parentName:"p"},"Caf.js Cloud")," account ",Object(c.b)("a",{parentName:"p",href:"https://root-launcher.cafjs.com"},"here"),"."),Object(c.b)("p",null,"Login and create an instance of the ",Object(c.b)("a",{parentName:"p",href:"https://github.com/cafjs/caf_turtles.git"},"Turtles")," deployer (app publisher ",Object(c.b)("code",{parentName:"p",className:"language-text"},"root"),", app name ",Object(c.b)("code",{parentName:"p",className:"language-text"},"turtles"),", choose any name for your instance)."),Object(c.b)("p",null,"To publish a ",Object(c.b)("strong",{parentName:"p"},"public")," ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Docker")," image containing your app, you need an account on a public Docker registry. For example, ",Object(c.b)("a",{parentName:"p",href:"https://hub.docker.com"},"Docker Hub"),",  ",Object(c.b)("a",{parentName:"p",href:"https://docs.github.com/en/packages/guides/about-github-container-registry"},"GitHub Container Registry"),", and ",Object(c.b)("a",{parentName:"p",href:"https://docs.gitlab.com/ee/user/packages/container_registry/"},"GitLab Container Registry"),", they all have free plans. We use internally the ",Object(c.b)("a",{parentName:"p",href:"https://cloud.google.com/container-registry"},"Google Container Registry"),"."),Object(c.b)("p",null,"If you do not have a registry account, but just want to try ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Turtles"),", the image for this example is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"gcr.io/cafjs-k8/root-webexample"),"."),Object(c.b)("h4",null,"Deploy"),Object(c.b)("p",null,"Let's create an image with the previous app. Change the image name prefix to match your registry provider."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," playground/app",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs mkImage ",Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},".")," gcr.io/cafjs-k8/root-webexample"))),Object(c.b)("p",null,"Ensure that it runs fine before uploading"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"cafjs run --appImage gcr.io/cafjs-k8/root-webexample myapp"))),Object(c.b)("p",null,"and then create test local instances as before."),Object(c.b)("p",null,"Now we are ready to upload the image"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"docker push gcr.io/cafjs-k8/root-webexample"))),Object(c.b)("p",null,"Login to ",Object(c.b)("em",{parentName:"p"},"Caf.js Cloud")," ",Object(c.b)("code",{parentName:"p",className:"language-text"},"https://root-launcher.cafjs.com")," using a browser."),Object(c.b)("p",null,"And then, to go live, you need to do two things:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Register the app with the top left menu."),Object(c.b)("li",{parentName:"ul"},"Deploy with ",Object(c.b)("code",{parentName:"li",className:"language-text"},"Turtles"),".")),Object(c.b)("p",null,"When you register this app, choose a name, a plan, and the percentage of profit that you want to make. Based on that your app gets a price in subscription-days per unit. A unit is 10 cents plus fees. See section ",Object(c.b)(N,{to:"../../hosting",mdxType:"Link"},"Caf.js Cloud")," for details."),Object(c.b)("p",null,"To deploy with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Turtles")," use the previous app and image names. Set ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Disable CDN")," to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"On"),", unless you have configured your own CDN in the image. You can also set environment properties for your app. We use properties to configure secrets since images are always public."),Object(c.b)("p",null,"Check the status of your app (assuming your username is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"antonio"),", and the app name is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"mycoolapp"),")"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token function"},"curl")," https://antonio-mycoolapp.cafjs.com/ping"))),Object(c.b)("p",null,"and monitor its performance with"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token function"},"curl")," https://antonio-mycoolapp.cafjs.com/stats"))),Object(c.b)("p",null,"After a few seconds, you, and ",Object(c.b)("strong",{parentName:"p"},"every other user"),", can create an instance of your app with the top-left menu, using your username ",Object(c.b)("code",{parentName:"p",className:"language-text"},"antonio")," as publisher, and the previous app name ",Object(c.b)("code",{parentName:"p",className:"language-text"},"mycoolapp"),"."),Object(c.b)("p",null,"And when they do, you ",Object(c.b)("strong",{parentName:"p"},"keep getting units")," for as long as they use your app."),Object(c.b)("p",null,"Maintaining a registered app costs one unit per week. Do not forget to ",Object(c.b)("strong",{parentName:"p"},"delete")," the app with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Turtles"),", ",Object(c.b)("strong",{parentName:"p"},"and unregister")," it with the top left menu, when you are done."),Object(c.b)("p",null,"With the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"People")," app, you can view stats for your registered apps, your active cloud assistants, or the current unit balance. You can also use this app to buy more units, or send/receive units to/from other users. This app is free and always installed.")),Object(c.b)(l,{id:"add-device",mdxType:"DocsSection"},Object(c.b)("h2",null,"Add a Simulated Device"),Object(c.b)("h4",null,"Software Requirements"),Object(c.b)("p",null,"When ",Object(c.b)("em",{parentName:"p"},"Caf.js")," simulates a device, it creates images for an ARM processor, and executes ARM binaries. The goal is to be as close as possible to the real thing."),Object(c.b)("p",null,"To do that, install in your Linux box the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"qemu-user-static")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"binfmt")," modules. For example, in Ubuntu:"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token function"},"sudo")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"apt-get")," update ",Object(c.b)("span",{parentName:"code",className:"token operator"},"&&")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"sudo")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"apt-get")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"install")," -y qemu-user-static binfmt-support"))),Object(c.b)("h4",null,"IoT Device App"),Object(c.b)("p",null,"Let's create an app that provides a ",Object(c.b)(N,{to:"/permanent",mdxType:"Link"},"permanent presence")," for an IoT device."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," playground",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"rm")," -fr app",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"  cafjs generate myapp iot ./app"))),Object(c.b)("p",null,"and then install, build, and run."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," app",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs ",Object(c.b)("span",{parentName:"code",className:"token function"},"install"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs build",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"  cafjs run -d myapp"))),Object(c.b)("p",null,"The ",Object(c.b)("a",{parentName:"p",href:"https://github.com/cafjs/caf_gadget.git"},"Gadget")," app manages IoT devices. Login with the local URL ",Object(c.b)("a",{parentName:"p",href:"http://root-launcher.vcap.me"},"http://root-launcher.vcap.me")," and create a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Gadget")," instance with publisher ",Object(c.b)("code",{parentName:"p",className:"language-text"},"root")," and app name ",Object(c.b)("code",{parentName:"p",className:"language-text"},"gadget"),". The instance name should match the name of the device, for example, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"device1"),"."),Object(c.b)("p",null,"Create an instance of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"myapp")," (publisher is always ",Object(c.b)("code",{parentName:"p",className:"language-text"},"root")," in local deployment), ensure that the instance name matches the device name, i.e., ",Object(c.b)("code",{parentName:"p",className:"language-text"},"device1"),"."),Object(c.b)("p",null,"Go back to the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Gadget")," instance and set the app name to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"root-myapp"),". This app does not need privileged mode, but most do, as the pop-up warning explains. You can also set environment properties for the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"node.js")," process running in the device."),Object(c.b)("p",null,"After ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Update")," you should see ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Token=yes")," because we created the app after the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Gadget")," instance. If that is not the case, just go back to the app, and the token will transparently propagate."),Object(c.b)("p",null,"Now we are ready to start the simulated device in another console. Note that the name of the device should be ",Object(c.b)("code",{parentName:"p",className:"language-text"},"device1"),"."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"cafjs device -d foo-device1"))),Object(c.b)("p",null,"The first thing the new device does is to download from its ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Gadget")," instance a Docker image spec for the current app. Building this ARM image takes about a minute in my laptop, but images are cached in the host, and only rebuild when the spec changes. Then, it starts the app in a container."),Object(c.b)("p",null,"Since we started the app with ",Object(c.b)("code",{parentName:"p",className:"language-text"},"-d")," (debug mode), you should see the debug logs in the console. If you go back to the instance of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"myapp"),", and click ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Do it!"),", you should see in the log ",Object(c.b)("code",{parentName:"p",className:"language-text"},"setPin")," set to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"true"),", and about a second later, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"setPin")," set to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"false"),". That's our blink."),Object(c.b)("p",null,"Debug mode also opens port ",Object(c.b)("code",{parentName:"p",className:"language-text"},"9230")," for attaching the Chrome browser developer tools. The catch is that the source path inside the container is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"/usr/src/app/lib"),", different from the host path. To set breakpoints, use this path when loading files."),Object(c.b)("p",null,"With three instances of the developer tools we can set breakpoints in the front end, the simulated cloud (port ",Object(c.b)("code",{parentName:"p",className:"language-text"},"9229"),"), and the simulated device (port ",Object(c.b)("code",{parentName:"p",className:"language-text"},"9230"),")."),Object(c.b)("p",null,"What has changed inside the box?"),Object(c.b)("p",null,"We have a new directory ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot")," with code that runs in the device. Two important files inside ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot/lib"),":"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"iot++.json")," Describes changes to the baseline IoT device configuration in ",Object(c.b)(N,{to:"../../apis/#caf_iot",mdxType:"Link"},"iot.json"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"iot_methods.js")," Your code.")),Object(c.b)("p",null,"Section ",Object(c.b)(N,{to:"#iot-device",mdxType:"Link"},"IoT Device")," covers ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot_methods.js"),"."),Object(c.b)("p",null,"In ",Object(c.b)("code",{parentName:"p",className:"language-text"},"lib/*.json")," we have added a new ",Object(c.b)(N,{to:"../../apis/#caf_iot",mdxType:"Link"},"IoT")," plugin. Also, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"ca_methods.js")," has new methods called by the device, and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"hello()")," propagates the authentication token to the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Gadget")," app.")),Object(c.b)(l,{id:"raspberry-pi",mdxType:"DocsSection"},Object(c.b)("h2",null,"Add a Raspberry Pi"),Object(c.b)("h4",null,"Requirements"),Object(c.b)("p",null,"Raspberry Pi 3/4 with a modern (2020 or later) Raspberry Pi OS."),Object(c.b)("p",null,"Install in the RPi both ",Object(c.b)("em",{parentName:"p"},"Docker")," and the ",Object(c.b)("em",{parentName:"p"},"Caf.js")," management daemon, as described in ",Object(c.b)(N,{to:"../../apis/#caf_rpi",mdxType:"Link"},"here"),"."),Object(c.b)("p",null,"For this discussion we assume ",Object(c.b)("em",{parentName:"p"},"Caf.js Cloud")," hosting. It is also possible to integrate an RPi with a local deployment by using the laptop external IP address, and not the local loop address. See ",Object(c.b)(N,{to:"#tools",mdxType:"Link"},"Tools")," for details."),Object(c.b)("h4",null,"IoT Device App"),Object(c.b)("p",null,"Deploy the previous ",Object(c.b)("code",{parentName:"p",className:"language-text"},"myapp")," in the Cloud. See ",Object(c.b)(N,{to:"#cafjs-cloud",mdxType:"Link"}," Caf.js Cloud"),"."),Object(c.b)("p",null,"When the name of the device is, for example, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"antonio-device1"),", both the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Gadget")," and ",Object(c.b)("code",{parentName:"p",className:"language-text"},"myapp")," instance names should be ",Object(c.b)("code",{parentName:"p",className:"language-text"},"device1"),"."),Object(c.b)("p",null,"After that, the experience should be similar to the simulated case. But instead of printing log messages, the GPIO pin in the RPi should turn on and off, blinking a light, or making a sound, based on what is connected to the GPIO pins.")),Object(c.b)(l,{id:"three-way-isomorphic",mdxType:"DocsSection"},Object(c.b)("h2",null,"Three-way Isomorphic"),Object(c.b)("p",null,"We discussed the benefits of a three-way isomorphic framework ",Object(c.b)(N,{to:"/permanent#three-way",mdxType:"Link"},"here"),"."),Object(c.b)("h4",null,"Requirements"),Object(c.b)("p",null,"We tested this app with a ",Object(c.b)("a",{parentName:"p",href:"https://www.puck-js.com/"},"Puck.js"),", a programmable Bluetooth beacon. This beacon is very easy to program using JavaScript, and we can add GATT services and advertisements with a few lines of code. See ",Object(c.b)("a",{parentName:"p",href:"https://github.com/cafjs/caf_hellopuckjs.git"},"HelloPuck")," for details."),Object(c.b)("p",null,"If you do not have a ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Puck.js"),", you should be able to easily adapt this example to other Bluetooth devices. Configure GATT services and characteristics in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"lib/ca++.json"),". Change payload types in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"iot/lib/iot_methods.js"),"."),Object(c.b)("p",null,"The Web Bluetooth API is supported by the ",Object(c.b)("em",{parentName:"p"},"Chrome")," browser in both Android and desktop platforms. ",Object(c.b)("em",{parentName:"p"},"Firefox")," or ",Object(c.b)("em",{parentName:"p"},"Safari")," will not work. For ",Object(c.b)("em",{parentName:"p"},"Apple iOS")," we have sucessfully run simple examples with the ",Object(c.b)("a",{parentName:"p",href:"https://apps.apple.com/us/app/webble/id1193531073"},"WebBLE")," browser, but some code changes are needed. ",Object(c.b)("a",{parentName:"p",href:"https://apps.apple.com/us/app/bluefy-web-ble-browser/id1492822055"},"Bluefy")," is another ",Object(c.b)("em",{parentName:"p"},"Apple iOS")," browser option."),Object(c.b)("h4",null,"Bluetooth App"),Object(c.b)("p",null,"Let's build a three-way isomorphic Bluetooth app with ",Object(c.b)("em",{parentName:"p"},"Caf.js"),"."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," playground",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," ",Object(c.b)("span",{parentName:"code",className:"token function"},"rm")," -fr app",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"  cafjs generate myapp iotbrowser ./app"))),Object(c.b)("p",null,"and then install, build, and run."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," app",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs ",Object(c.b)("span",{parentName:"code",className:"token function"},"install"),Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," cafjs build",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";"),"  cafjs run -d myapp"))),Object(c.b)("p",null,"With ",Object(c.b)("em",{parentName:"p"},"Chrome"),", login and create an instance of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"myapp")," with publisher ",Object(c.b)("code",{parentName:"p",className:"language-text"},"root"),", app name ",Object(c.b)("code",{parentName:"p",className:"language-text"},"myapp"),", and instance name ",Object(c.b)("code",{parentName:"p",className:"language-text"},"puck1"),"."),Object(c.b)("p",null,"Switch the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Browser Daemon")," option to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"on"),". It will create a tab with a new hostname ",Object(c.b)("code",{parentName:"p",className:"language-text"},"http://root-myapp.localhost:3003/"),". Chrome allows subdomains for ",Object(c.b)("code",{parentName:"p",className:"language-text"},"localhost"),", and port ",Object(c.b)("code",{parentName:"p",className:"language-text"},"3003")," provides direct access to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"myapp"),". The Web Bluetooth API requires ",Object(c.b)("code",{parentName:"p",className:"language-text"},"https")," or ",Object(c.b)("code",{parentName:"p",className:"language-text"},"localhost"),". It is also blocked inside a cross-origin iframe. By spawning the iframe into its own page, with a new hostname, we avoid these limitations."),Object(c.b)("p",null,"Click ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Find"),", then ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Click to Pair"),", select the compatible device, and then confirm. After that, blink the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Puck.js")," light, or click the physical ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Puck.js")," button to start receiving notification from the beacon. Sharing a URL allows someone remote to interact with the beacon, see ",Object(c.b)(N,{to:"/permanent",mdxType:"Link"},"Permanent Presence"),"."),Object(c.b)("p",null,"The bridging code runs inside the iframe ",Object(c.b)("code",{parentName:"p",className:"language-text"},"index-iot.html"),", with the same origin as the top context. Using the ",Object(c.b)("em",{parentName:"p"},"Chrome")," developer tools we can debug device code by targeting this iframe."),Object(c.b)("p",null,"What about isomorphic?"),Object(c.b)("p",null,"We can deploy this app unchanged on a Raspberry Pi, see the previous ",Object(c.b)(N,{to:"#raspberry-pi",mdxType:"Link"},"section"),". Keep the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Browser Daemon")," option to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"off"),". The user interface simplifies, with fewer clicks, but the overall functionality is similar."),Object(c.b)("p",null,"Note that you should use a different instance name, matching the Raspberry Pi name, for example, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"rpi1")," instead of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"puck1"),". Never reuse an instance name for both browser and RPi."),Object(c.b)("p",null,"And this application also executes device code in the Cloud, introspecting device methods in the ",Object(c.b)(N,{to:"../../apis/#caf_iot",mdxType:"Link"},"IoT plugin"),"."),Object(c.b)("p",null,"Some important code changes:"),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},"Modify the build system in ",Object(c.b)("code",{parentName:"li",className:"language-text"},"bin/build.sh")," to ",Object(c.b)("code",{parentName:"li",className:"language-text"},"browserify")," device code."),Object(c.b)("li",{parentName:"ul"},"Introduce ",Object(c.b)("code",{parentName:"li",className:"language-text"},"iot/lib/main-shim.js")," as the new entry point for the device in the browser."),Object(c.b)("li",{parentName:"ul"},"Spawn a page that executes device code in an iframe (",Object(c.b)("code",{parentName:"li",className:"language-text"},"public/js/components/Finder.js"),")."),Object(c.b)("li",{parentName:"ul"},"Add a ",Object(c.b)(N,{to:"../../apis/#caf_iot_gatt",mdxType:"Link"},"Bluetooth plugin")," in ",Object(c.b)("code",{parentName:"li",className:"language-text"},"iot/lib/iot++.json"),"."),Object(c.b)("li",{parentName:"ul"},"Add a React app for remote interaction in ",Object(c.b)("code",{parentName:"li",className:"language-text"},"public/user"),".")))),Object(c.b)(r,{id:"apis",mdxType:"DocsArticle"},Object(c.b)("h1",null,"APIs"),Object(c.b)("p",null,"You can see the jsdoc documentation ",Object(c.b)(N,{to:"/apis",mdxType:"Link"},"here"))),Object(c.b)(r,{id:"tools",mdxType:"DocsArticle"},Object(c.b)("h1",null,"Tools"),Object(c.b)(l,{id:"cafjs-tool",mdxType:"DocsSection"},Object(c.b)("h2",null,"cafjs"),Object(c.b)("p",null,Object(c.b)("code",{parentName:"p",className:"language-text"},"cafjs")," is a wrapper to all our command line tools."),Object(c.b)("p",null,"Type ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cafjs help")," for an overview of the subcommands, and, for example, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cafjs device --help")," for a description of the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"device")," subcommand options."),Object(c.b)("p",null,"A detailed description of ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cafjs")," can be found in ",Object(c.b)(N,{to:"../../apis/#caf_dcinabox",mdxType:"Link"},"here")),Object(c.b)("p",null,"Let's enumerate the most important subcommands, and link to usage examples in this documentation."),Object(c.b)("ul",null,Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"run"),"  sets up a simulated cloud with Docker containers, mounts a local volume or an image with your app, and then starts it. ",Object(c.b)(N,{to:"#install",mdxType:"Link"},"Example"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"install")," installs all the workspace packages for your app. ",Object(c.b)(N,{to:"#headless-example",mdxType:"Link"},"Example"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"build")," builds an application using local dependencies. ",Object(c.b)(N,{to:"#install",mdxType:"Link"},"Example"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"reset")," brute force clean-up of docker containers and virtual networks. ",Object(c.b)(N,{to:"#install",mdxType:"Link"},"Example"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"device")," simulates a device. ",Object(c.b)(N,{to:"#add-device",mdxType:"Link"},"Example"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"mkImage")," builds a Docker image from a packed app or directory. ",Object(c.b)(N,{to:"#cafjs-cloud",mdxType:"Link"},"Example"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"generate")," creates an skeleton app using a template. ",Object(c.b)(N,{to:"#headless-example",mdxType:"Link"},"Example"),"."),Object(c.b)("li",{parentName:"ul"},Object(c.b)("code",{parentName:"li",className:"language-text"},"update")," pulls the current core Docker images. ",Object(c.b)(N,{to:"#install",mdxType:"Link"},"Example"),".")),Object(c.b)("h4",null,"Local Multi-Host Deployment"),Object(c.b)("p",null,"To attach a real device to a local ",Object(c.b)("em",{parentName:"p"},"Caf.js")," deployment, the network interface that ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cafjs run")," uses has to change. By default, the Docker containers use local IP addresses, which are not accessible outside your laptop."),Object(c.b)("p",null,"Another difficulty is obtaining a wildcard domain for your external interface. In the default case, ",Object(c.b)("em",{parentName:"p"},"Caf.js")," uses ",Object(c.b)("code",{parentName:"p",className:"language-text"},"vcap.me"),", which redirects ",Object(c.b)("code",{parentName:"p",className:"language-text"},"*.vcap.me")," to the local IP address ",Object(c.b)("code",{parentName:"p",className:"language-text"},"127.0.0.1"),"."),Object(c.b)("p",null,"For external IP addresses, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cafjs run")," internally uses the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"xip.io")," service, which redirects ",Object(c.b)("code",{parentName:"p",className:"language-text"},"*.192.168.1.15.xip.io")," to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"192.168.1.15"),"."),Object(c.b)("p",null,"Assuming that this address is your laptop external IP address, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"192.168.1.15.xip.io")," is your new wildcard domain. The option ",Object(c.b)("code",{parentName:"p",className:"language-text"},"--port 8080")," sets your external port to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"8080"),". And then, the login url becomes ",Object(c.b)("code",{parentName:"p",className:"language-text"},"http://root-launcher.192.168.1.15.xip.io:8080"),"."),Object(c.b)("p",null,"Start your application"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"cafjs run --ipAddress ",Object(c.b)("span",{parentName:"code",className:"token number"},"192.168"),".1.15 --port ",Object(c.b)("span",{parentName:"code",className:"token number"},"8080")," myapp"))),Object(c.b)("p",null,"and, in another host, the simulated device"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"cafjs device -d --ipAddress ",Object(c.b)("span",{parentName:"code",className:"token number"},"192.168"),".1.15 --port ",Object(c.b)("span",{parentName:"code",className:"token number"},"8080")," --password bar foo-device1"))),Object(c.b)("p",null,"To use a real Raspberry Pi we adapt the startup script in ",Object(c.b)("a",{parentName:"p",href:"https://raw.githubusercontent.com/cafjs/caf_rpi/master/setup.sh"},"setup.sh"),", to first obtain a token from the local service. Assuming device id is ",Object(c.b)("code",{parentName:"p",className:"language-text"},"foo-device1"),", password ",Object(c.b)("code",{parentName:"p",className:"language-text"},"bar"),", and using the root account in the RPi:"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},Object(c.b)("span",{parentName:"code",className:"token function"},"mkdir")," -p /config2",Object(c.b)("span",{parentName:"code",className:"token punctuation"},";")," ",Object(c.b)("span",{parentName:"code",className:"token builtin class-name"},"cd")," /config2\ndocker run --rm -e ",Object(c.b)("span",{parentName:"code",className:"token assign-left variable"},"ACCOUNTS_URL"),Object(c.b)("span",{parentName:"code",className:"token operator"},"="),"http://root-accounts.192.168.1.15.xip.io:8080 -e ",Object(c.b)("span",{parentName:"code",className:"token assign-left variable"},"MY_ID"),Object(c.b)("span",{parentName:"code",className:"token operator"},"="),"foo-device1 -e ",Object(c.b)("span",{parentName:"code",className:"token assign-left variable"},"PASSWD"),Object(c.b)("span",{parentName:"code",className:"token operator"},"="),"bar -v /config2:/config gcr.io/cafjs-k8/root-rpitoken\n",Object(c.b)("span",{parentName:"code",className:"token function"},"chmod")," ",Object(c.b)("span",{parentName:"code",className:"token number"},"600")," token\n"))),Object(c.b)("p",null,"and then start the daemon with the new suffix, port, and protocol."),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"docker run -d --name",Object(c.b)("span",{parentName:"code",className:"token operator"},"="),"root-rpidaemon2 --restart",Object(c.b)("span",{parentName:"code",className:"token operator"},"="),"always -e ",Object(c.b)("span",{parentName:"code",className:"token assign-left variable"},"IS_REGISTRY_PRIVATE"),Object(c.b)("span",{parentName:"code",className:"token operator"},"="),"false -e ",Object(c.b)("span",{parentName:"code",className:"token assign-left variable"},"APP_SUFFIX"),Object(c.b)("span",{parentName:"code",className:"token operator"},"="),Object(c.b)("span",{parentName:"code",className:"token number"},"192.168"),".1.15.xip.io:8080 -e ",Object(c.b)("span",{parentName:"code",className:"token assign-left variable"},"MY_ID"),Object(c.b)("span",{parentName:"code",className:"token operator"},"="),"foo-device1 -v /var/run/docker.sock:/var/run/docker.sock  -v /config2:/config -e ",Object(c.b)("span",{parentName:"code",className:"token assign-left variable"},"APP_PROTOCOL"),Object(c.b)("span",{parentName:"code",className:"token operator"},"="),"http   -e ",Object(c.b)("span",{parentName:"code",className:"token assign-left variable"},"CONFIG_VOLUME"),Object(c.b)("span",{parentName:"code",className:"token operator"},"="),"/config2 gcr.io/cafjs-k8/root-rpidaemon"))),Object(c.b)("p",null,Object(c.b)("code",{parentName:"p",className:"language-text"},"xip.io")," can be temperamental. An equivalent service, ",Object(c.b)("code",{parentName:"p",className:"language-text"},"nip.io"),", could also be used by setting the property ",Object(c.b)("code",{parentName:"p",className:"language-text"},"XIP_SUFFIX")," to ",Object(c.b)("code",{parentName:"p",className:"language-text"},"nip.io"),", i.e., ",Object(c.b)("code",{parentName:"p",className:"language-text"},"export XIP_SUFFIX=nip.io; cafjs run ..."),", and replacing the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"xip.io")," suffix by ",Object(c.b)("code",{parentName:"p",className:"language-text"},"nip.io")," in the scripts."),Object(c.b)("p",null,"What about ",Object(c.b)("code",{parentName:"p",className:"language-text"},"https"),"? In most cases you don't need it for development. For example, to enable WebXR APIs that need ",Object(c.b)("code",{parentName:"p",className:"language-text"},"localhost")," or ",Object(c.b)("code",{parentName:"p",className:"language-text"},"https"),", we use instead the Chrome developer tools, which provide local port forwarding, and then connect to the laptop USB port the Oculus headset, or Android phone, in debug mode. And now we can use a wildcard domain based on localhost, as shown in ",Object(c.b)(N,{to:"#three-way-isomorphic",mdxType:"Link"}," Three-way Isomorphic"),"."),Object(c.b)("p",null,"But if you really want ",Object(c.b)("code",{parentName:"p",className:"language-text"},"https"),", you need a wildcard certificate, or a service like ",Object(c.b)("a",{parentName:"p",href:"https://ngrok.com"},"ngrok"),", and configure the ",Object(c.b)("code",{parentName:"p",className:"language-text"},"APP_SUFFIX")," property with your new wildcard domain."),Object(c.b)("h4",null,"Custom templates for 'cafjs generate'"),Object(c.b)("p",null,"The repository ",Object(c.b)("a",{parentName:"p",href:"https://github.com/cafjs/caf_template.git"},"caf_template")," contains the default template for ",Object(c.b)("code",{parentName:"p",className:"language-text"},"cafjs generate"),"."),Object(c.b)("p",null,"A template is a Docker image that contains mostly data. The Docker entrypoint is the top level script ",Object(c.b)("code",{parentName:"p",className:"language-text"},"copyAll.sh"),". Just copy this file into your image. The subdirectories in ",Object(c.b)("code",{parentName:"p",className:"language-text"},"templates")," define the target names for ",Object(c.b)("code",{parentName:"p",className:"language-text"},"generate"),". Mustache template files have the extension ",Object(c.b)("code",{parentName:"p",className:"language-text"},".mustache"),"."),Object(c.b)("p",null,"To use a different template:"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"cafjs generate --templateImage gcr.io/your_image myapp"))),Object(c.b)("p",null,"and to refresh the template before using it"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"cafjs generate --update --templateImage gcr.io/your_image myapp"))),Object(c.b)("p",null,"or just"),Object(c.b)("div",{className:"gatsby-highlight","data-language":"shell"},Object(c.b)("pre",{parentName:"div",className:"language-shell"},Object(c.b)("code",{parentName:"pre",className:"language-shell"},"docker pull  gcr.io/your_image"))))),Object(c.b)(r,{id:"resources",mdxType:"DocsArticle"},Object(c.b)("h1",null,"Resources"),Object(c.b)("p",null,"There are many small examples in the main ",Object(c.b)("em",{parentName:"p"},"Caf.js")," packages. Look under ",Object(c.b)("code",{parentName:"p",className:"language-text"},"./examples"),". They run without a container, with security off, and they are a simple way to get started."),Object(c.b)("p",null,"There are also sixteen example apps in the top ",Object(c.b)("code",{parentName:"p",className:"language-text"},"Caf.js")," repo, under ",Object(c.b)("code",{parentName:"p",className:"language-text"},"./apps"),". Some are better written than others, but together they give you a good overview of what the framework can do. Most of them are already deployed in the ",Object(c.b)("em",{parentName:"p"},"Caf.js Cloud"),"."))))}d.isMDXComponent=!0}}]);
//# sourceMappingURL=790a076b-8302521063d380821340.js.map